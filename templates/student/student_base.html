<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>{% block title %}{{ brand_title or 'PiyuGuide' }} â€” {{ current_campus_name or 'Student Portal' }}{% endblock %}</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for icons -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/customs.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.socket.io/4.0.1/socket.io.min.js"></script>
    <!-- Global CSRF token -->
    <meta name="csrf-token" content="{{ csrf_token() }}" />
    {% block extra_head %}{% endblock %}
    <style>
      body {
        font-family: 'Inter', sans-serif;
      }

      /* Custom scrollbar */
      ::-webkit-scrollbar {
        width: 6px;
      }
      ::-webkit-scrollbar-track {
        background: #f1f5f9;
      }
      ::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 3px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: #94a3b8;
      }

      /* Modern gradient backgrounds */
      .navbar-gradient {
        background: linear-gradient(135deg, #1e40af 0%, #3730a3 50%, #4338ca 100%);
        box-shadow: 0 4px 20px rgba(30, 64, 175, 0.3);
      }

      .sidebar-gradient {
        background: linear-gradient(180deg, #ffffff 0%, #f8fafc 100%);
        border-right: 1px solid #e2e8f0;
      }

      .profile-card-gradient {
        background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 50%, #eff6ff 100%);
        border: 1px solid #93c5fd;
      }

      /* Enhanced sidebar styles */
      .sidebar-item {
        transition: all 0.3s ease;
        border-radius: 0.5rem;
        margin: 0.125rem 0.75rem;
        position: relative;
        overflow: hidden;
      }

      .sidebar-item:hover {
        background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
        transform: translateX(4px);
        box-shadow: 0 2px 8px rgba(30, 64, 175, 0.1);
      }

      .active-nav {
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        color: white !important;
        font-weight: 600;
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
      }

      .active-nav:hover {
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        transform: translateX(0);
      }

      /* Enhanced notification styles */
      .notification-item {
        transition: all 0.3s ease;
      }
      .notification-item:hover {
        background-color: #f3f4f6;
      }
      .notification-item.unread {
        border-left: 3px solid #3b82f6;
        background-color: rgba(59, 130, 246, 0.05);
      }
      .notification-close {
        opacity: 0;
        transition: opacity 0.2s ease;
      }
      .notification-item:hover .notification-close {
        opacity: 1;
      }
      .notification-content {
        word-break: break-word;
      }      .notification-preview {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
      }

      /* Enhanced dropdown styles */
      .dropdown {
        position: relative;
        display: inline-block;
      }

      .dropdown-content {
        /* Default hidden; toggled via JS to avoid sticky :hover on touch */
        display: none;
        position: absolute;
        right: 0;
        background: white;
        min-width: 200px;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        z-index: 1000;
        border-radius: 0.75rem;
        border: 1px solid #e2e8f0;
        overflow: hidden;
        backdrop-filter: blur(8px);
      }

      @keyframes fadeInUp {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* Enhanced notification badge */
      .notification-badge {
        position: absolute;
        top: -8px;
        right: -8px;
        font-size: 10px;
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        color: white;
        border-radius: 50%;
        padding: 3px 6px;
        font-weight: 600;
        border: 2px solid white;
        box-shadow: 0 2px 4px rgba(239, 68, 68, 0.3);
        animation: pulse 2s infinite;
      }

      @keyframes pulse {
        0%, 100% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.1);
        }
      }      /* Shortcut cards styles */
      .shortcut-card {
        background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
        border: 2px solid #0ea5e9;
        border-radius: 1rem;
        transition: all 0.3s ease;
        cursor: pointer;
        overflow: hidden;
        position: relative;
        box-shadow: 0 4px 12px rgba(14, 165, 233, 0.15);
      }

      .shortcut-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 15px 35px rgba(14, 165, 233, 0.25);
        border-color: #0284c7;
      }

      .shortcut-card.inquiry-card {
        background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
        border-color: #f59e0b;
        box-shadow: 0 4px 12px rgba(245, 158, 11, 0.15);
      }

      .shortcut-card.inquiry-card:hover {
        border-color: #d97706;
        box-shadow: 0 15px 35px rgba(245, 158, 11, 0.25);
      }

      .shortcut-card.counseling-card {
        background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
        border-color: #10b981;
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.15);
      }

      .shortcut-card.counseling-card:hover {
        border-color: #059669;
        box-shadow: 0 15px 35px rgba(16, 185, 129, 0.25);
      }

      /* Enhanced shortcut icons */
      .shortcut-icon {
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.9) 0%, rgba(255, 255, 255, 0.7) 100%);
        border: 2px solid rgba(255, 255, 255, 0.3);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        backdrop-filter: blur(10px);
        transition: all 0.3s ease;
      }

      .shortcut-card:hover .shortcut-icon {
        transform: scale(1.1);
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
      }

      /* Quick stats styles */
      .quick-stats {
        background: linear-gradient(135deg, #fafafa 0%, #f4f4f5 100%);
        border: 1px solid #e4e4e7;
        border-radius: 1rem;
        padding: 1rem;
        margin: 0.5rem 0;
        transition: all 0.3s ease;
      }

      .quick-stats:hover {
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        transform: translateY(-2px);
      }

      .stat-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0.5rem 0;
        border-bottom: 1px solid #f4f4f5;
      }

      .stat-item:last-child {
        border-bottom: none;
      }

      .stat-value {
        font-weight: 700;
        font-size: 1.1rem;
      }

      /* Counter badges */
      .counter-badge {
        font-size: 10px;
        font-weight: 600;
        border-radius: 1rem;
        padding: 2px 8px;
        border: 1px solid rgba(255, 255, 255, 0.2);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .counter-red {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        color: white;
      }

      .counter-blue {
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        color: white;
      }

      .counter-green {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
      }

      /* Profile section enhancements */
      .profile-section {
        background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
        border: 1px solid #93c5fd;
        border-radius: 1rem;
        margin: 1rem;
        padding: 1rem;
        box-shadow: 0 4px 12px rgba(30, 64, 175, 0.1);
      }

      /* Navigation section headers */
      .nav-section-header {
        color: #64748b;
        font-weight: 600;
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        padding: 0.75rem 1rem 0.5rem;
        border-bottom: 1px solid #e2e8f0;
        margin-bottom: 0.5rem;
        background: linear-gradient(90deg, #f8fafc 0%, transparent 100%);
      }

      /* Status indicator improvements */
      .status-indicator {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        border: 2px solid white;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        position: absolute;
        bottom: -2px;
        right: -2px;
      }

      .status-online {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        animation: statusPulse 2s infinite;
      }

      @keyframes statusPulse {
        0%, 100% {
          box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1), 0 0 0 0 rgba(16, 185, 129, 0.7);
        }
        50% {
          box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1), 0 0 0 4px rgba(16, 185, 129, 0);
        }
      }

      /* Main content area */
      .main-content {
        background: #f8fafc;
        border-radius: 1rem 0 0 0;
        overflow: hidden;
      }
      /* Sidebar profile email responsiveness */
      .profile-email {
        display: block;
        font-size: 0.7rem;
        line-height: 1rem;
        color: #64748b;
        max-width: 100%;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }
      /* Allow wrapping below certain height / width constraints */
      @media (max-height: 760px), (max-width: 1024px) {
        .profile-email {
          white-space: normal;
          word-break: break-all;
          overflow-wrap: anywhere;
          display: -webkit-box;
          line-clamp: 2;
          -webkit-line-clamp: 2;
          -webkit-box-orient: vertical;
        }
      }
      /* Ensure parent flex doesn't squeeze email */
      .profile-section .flex.items-center { align-items: flex-start; }
      @media (min-width: 768px) {
        .profile-section .flex.items-center { align-items: center; }
      }
    </style>
  </head>  <body class="bg-gray-50 flex flex-col h-screen overflow-hidden">
    <!-- Top Navigation Bar -->
    <header class="navbar-gradient text-white shadow-md relative z-30">
      <div class="container mx-auto px-4">
        <div class="flex justify-between items-center py-3">
          <div class="flex items-center space-x-4">
            <!-- Mobile menu button -->
            <button
              id="mobileMenuBtn"
              class="md:hidden text-white focus:outline-none"
              aria-controls="sidebar"
              aria-expanded="false"
            >
              <i class="fas fa-bars text-xl" aria-hidden="true"></i>
              <span class="sr-only">Open navigation menu</span>
            </button>

            <!-- Logo -->
            <a
              href="{{ url_for('student.dashboard') }}"
              class="flex items-center"
            >
              <img
                src="{{ brand_logo_url or url_for('static', filename='images/schoollogo.png') }}"
                alt="{{ brand_title or 'PiyuGuide' }} Logo"
                class="h-10 w-10 rounded-full border-2 border-white/20 shadow-lg"
              />
              <div class="ml-3">
                <span class="text-xl font-bold tracking-tight">{{ brand_title or 'PiyuGuide' }}</span>
                <p class="text-sm text-blue-100 font-medium">{{ current_campus_name or 'Student Portal' }}</p>
              </div>
            </a>
          </div>

          <div class="flex items-center space-x-6">
            <div class="hidden md:flex items-center space-x-2 bg-white/10 rounded-full px-4 py-2 backdrop-blur-sm">
              <i class="fas fa-user-graduate text-blue-200"></i>
              <span class="text-sm font-medium">
                Welcome, <span class="font-bold">{{ current_user.first_name }}!</span>
              </span>
            </div>

            <!-- Unified Notifications (Office-style for Students) -->
            <div class="relative" id="student-ann-bell-wrapper">
              <button id="student-ann-bell" class="group relative w-11 h-11 rounded-full bg-white/10 flex items-center justify-center hover:bg-white/20 transition-all duration-300 focus:outline-none focus:ring-2 focus:ring-white/30">
                <i class="fas fa-bell text-lg text-white transition-transform group-hover:scale-110"></i>
                <span id="student-ann-badge" class="absolute -top-1 -right-1 min-w-[20px] h-[20px] px-1 bg-gradient-to-br from-red-500 to-red-600 text-white text-[10px] leading-[18px] rounded-full text-center font-semibold shadow {% if unread_notifications_count == 0 %}hidden{% endif %}">{{ unread_notifications_count }}</span>
              </button>
              <div id="student-ann-dropdown" class="absolute right-0 mt-3 w-[430px] bg-white/95 rounded-2xl border border-gray-200 z-50 overflow-hidden hidden">
                <div class="px-5 py-4 flex items-center justify-between bg-gradient-to-r from-blue-50 to-blue-100/70 backdrop-blur-sm border-b border-gray-200/70">
                  <div class="font-semibold text-gray-800 flex items-center gap-2 text-sm tracking-wide"><span class="relative inline-flex items-center justify-center w-8 h-8 rounded-xl bg-gradient-to-br from-blue-600 to-indigo-600 text-white shadow"><i class="fas fa-bell"></i></span><span>Notifications</span></div>
                  <div class="flex items-center gap-3">
                    <button id="student-ann-refresh" class="text-xs px-2.5 py-1.5 rounded-lg bg-white/70 hover:bg-white text-blue-700 font-medium shadow-sm border border-blue-100 transition">Refresh</button>
                    <button id="student-ann-mark-all" class="text-xs px-2.5 py-1.5 rounded-lg bg-blue-600 hover:bg-blue-700 text-white font-medium shadow-sm transition">Mark all read</button>
                  </div>
                </div>
        <div id="student-ann-list" class="max-h-96 overflow-y-auto divide-y divide-transparent">
                  {% if notifications %}
                    {% for n in notifications %}
          <a href="{% if n.inquiry_id %}{{ url_for('student.view_inquiry', inquiry_id=n.inquiry_id) }}{% elif n.announcement_id %}{{ url_for('student.view_announcement', announcement_id=n.announcement_id) }}{% else %}{{ url_for('student.notifications') }}{% endif %}"
             data-id="{{ n.id }}"
             {% if n.announcement_id %} data-announcement-id="{{ n.announcement_id }}"{% endif %}
             class="office-ann-item relative px-4 py-3 transition-colors {{ 'unread' if not n.is_read else '' }}"
             data-title="{{ n.title|e }}" data-message="{{ n.message|e }}">
                      <div class="icon-pill bg-gradient-to-br from-blue-600 to-indigo-600 text-white shadow-inner"><i class="fa-solid fa-bell"></i></div>
                      <div class="ann-body">
                        <div class="ann-title">{{ n.title }}</div>
                        <div class="ann-msg line-clamp-2">{{ n.message }}</div>
                        <div class="ann-meta"><i class="fas fa-clock"></i>{{ n.created_at|dt12 }}</div>
                      </div>
                    </a>
                    {% endfor %}
                  {% else %}
                  <div class="office-ann-empty text-gray-500 text-sm">
                    <i class="fas fa-bell-slash text-3xl mb-3 block"></i>
                    <p class="font-medium">No notifications yet</p>
                    <p class="text-xs mt-1 text-gray-400">You're all caught up!</p>
                  </div>
                  {% endif %}
                </div>
                <div class="border-t border-gray-100/80 bg-gray-50/60 backdrop-blur-sm flex items-center justify-between px-5 py-3">
                  <a href="{{ url_for('student.notifications') }}" class="text-[11px] tracking-wide font-semibold text-blue-700 hover:text-blue-900 uppercase flex items-center gap-1">View All <i class="fas fa-arrow-right text-[10px]"></i></a>
                  <span class="text-[10px] text-gray-400 font-medium select-none">Real-time updates</span>
                </div>
              </div>
            </div>

            <!-- User Dropdown -->
            <div class="dropdown" id="userDropdown">
              <!-- Avatar now toggles the dropdown menu directly (no extra caret) -->
              <button
                id="userMenuToggle"
                class="group relative w-11 h-11 rounded-full bg-white/10 flex items-center justify-center hover:bg-white/20 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-white/30"
                aria-haspopup="true"
                aria-expanded="false"
                aria-controls="userMenu"
                title="Open user menu"
              >
                {% set avatar_url = current_user.profile_pic_path and url_for('static', filename=current_user.profile_pic_path) %}
                {% if avatar_url %}
                <img
                  src="{{ avatar_url }}"
                  alt="User avatar"
                  class="w-full h-full rounded-full object-cover"
                />
                {% else %}
                <span class="font-semibold text-sm text-white">{{ current_user.first_name[0] }}{{ current_user.last_name[0] }}</span>
                {% endif %}
                <!-- subtle online dot -->
                <span class="absolute -bottom-0.5 -right-0.5 w-3 h-3 rounded-full ring-2 ring-indigo-700/40 bg-green-400"></span>
              </button>

              <!-- User Dropdown Menu -->
        <div class="dropdown-content text-gray-800 mt-2" id="userMenu" role="menu" aria-labelledby="userMenuToggle">
                <div class="px-4 py-3 bg-gradient-to-r from-blue-50 to-blue-100 border-b border-blue-200">
                  <div class="flex items-center">
                    <div class="w-8 h-8 rounded-full bg-blue-600 flex items-center justify-center text-white text-sm font-bold mr-3">
                      {{ current_user.first_name[0] }}{{ current_user.last_name[0] }}
                    </div>
                    <div>
                      <div class="font-semibold text-gray-800">{{ current_user.first_name }} {{ current_user.last_name }}</div>
                      <div class="text-xs text-gray-500">{{ current_user.role|replace('_', ' ')|title }}</div>
                    </div>
                  </div>
                </div>                <a
                  href="{{ url_for('student.profile') }}"
                  class="block px-4 py-3 hover:bg-blue-50 transition-colors duration-200"
          role="menuitem"
                >
                  <i class="fas fa-user-circle mr-3 text-blue-600"></i> My Profile
                </a>
                <a
                  href="{{ url_for('student.account_settings') }}"
                  class="block px-4 py-3 hover:bg-blue-50 transition-colors duration-200"
          role="menuitem"
                >
                  <i class="fas fa-cog mr-3 text-gray-600"></i> Account Settings
                </a>
                <hr class="my-1">
                <a
                  href="{{ url_for('auth.logout') }}"
                  class="block px-4 py-3 hover:bg-red-50 text-red-600 transition-colors duration-200"
          role="menuitem"
                >                  <i class="fas fa-sign-out-alt mr-3"></i> Logout
                </a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </header>

    <div class="flex flex-1 overflow-hidden">
      <!-- Sidebar - Responsive -->
  <aside class="sidebar-gradient w-72 flex-shrink-0 overflow-y-auto shadow-xl z-40 md:z-auto hidden md:block fixed md:static inset-y-0 left-0 transform transition-transform duration-300 -translate-x-full md:translate-x-0" id="sidebar" role="navigation" aria-label="Student navigation">
        <div class="h-full flex flex-col">
          <!-- Mobile header with close button -->
          <div class="md:hidden flex items-center justify-between px-4 py-3 border-b border-gray-200 bg-white/80 backdrop-blur">
            <span class="text-sm font-semibold text-gray-700">Menu</span>
            <button id="sidebarCloseBtn" class="text-gray-600 hover:text-gray-800 p-2 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" aria-label="Close sidebar">
              <i class="fas fa-times"></i>
            </button>
          </div>
          <!-- Student Profile Section -->
          <div class="profile-section">
            <div class="flex items-center">
              <div class="relative mr-4">
                <div class="w-14 h-14 rounded-xl overflow-hidden bg-gradient-to-br from-blue-600 to-blue-700 shadow-lg ring-2 ring-white ring-opacity-60">
                  {% set side_avatar_url = current_user.profile_pic_path and url_for('static', filename=current_user.profile_pic_path) %}
                  {% if side_avatar_url %}
                  <img
                    src="{{ side_avatar_url }}"
                    alt="Profile Picture"
                    class="w-full h-full object-cover"
                  />
                  {% else %}
                  <div class="w-full h-full flex items-center justify-center text-white text-lg font-bold">
                    {{ current_user.first_name[0] }}{{ current_user.last_name[0] }}
                  </div>
                  {% endif %}
                </div>
                <!-- Enhanced status indicator -->
                <div
                  class="status-indicator status-online"
                  title="Online"
                ></div>
              </div>
              <div class="flex-1">
                <h3 class="font-bold text-gray-800 text-base">
                  {{ current_user.first_name }} {{ current_user.last_name }}
                </h3>
                <p class="profile-email mb-2" title="{{ current_user.email }}">{{ current_user.email }}</p>
                <div class="flex items-center space-x-2">
                  <span class="bg-gradient-to-r from-blue-500 to-blue-600 text-white text-xs px-3 py-1 rounded-full font-medium shadow-sm">
                    <i class="fas fa-user-graduate mr-1"></i>
                    Student
                  </span>
                  <span class="bg-gradient-to-r from-green-400 to-green-500 text-white text-xs px-2 py-1 rounded-full font-medium shadow-sm" title="Active Status">
                    <i class="fas fa-circle text-xs"></i>
                  </span>
                </div>
              </div>
            </div>
          </div><!-- Quick Action Shortcuts -->          <div class="px-4 py-4">
            <div class="nav-section-header">
              <i class="fas fa-rocket mr-2 text-blue-600"></i>
              Quick Actions
            </div>
            <div class="space-y-2">
              <!-- Submit Inquiry Shortcut -->              <a href="{{ url_for('student.university_offices') }}" class="shortcut-card inquiry-card p-3 block group">
                <div class="flex items-center">
                  <div class="shortcut-icon w-10 h-10 rounded-lg bg-gradient-to-br from-amber-500 to-orange-600 flex items-center justify-center text-white shadow-lg group-hover:shadow-xl transition-all duration-300">
                    <i class="fas fa-question-circle text-sm"></i>
                  </div>
                  <div class="ml-3 flex-1">
                    <h4 class="font-medium text-amber-800 text-sm group-hover:text-amber-900 transition-colors">Submit Inquiry</h4>
                    <p class="text-xs text-amber-700 mt-0.5 group-hover:text-amber-800 transition-colors">Ask questions and get help</p>
                  </div>
                  <div class="text-amber-600 group-hover:text-amber-700 group-hover:translate-x-1 transition-all duration-300">
                    <i class="fas fa-arrow-right text-sm"></i>
                  </div>
                </div>
              </a><!-- Request Counseling Session Shortcut -->              <a href="{{ url_for('student.request_counseling_session') }}" class="shortcut-card counseling-card p-3 block group">
                <div class="flex items-center">
                  <div class="shortcut-icon w-10 h-10 rounded-lg bg-gradient-to-br from-green-500 to-emerald-600 flex items-center justify-center text-white shadow-lg group-hover:shadow-xl transition-all duration-300">
                    <i class="fas fa-user-md text-sm"></i>
                  </div>
                  <div class="ml-3 flex-1">
                    <h4 class="font-medium text-green-800 text-sm group-hover:text-green-900 transition-colors">Request Counseling</h4>
                    <p class="text-xs text-green-700 mt-0.5 group-hover:text-green-800 transition-colors">Schedule counseling session</p>
                  </div>
                  <div class="text-green-600 group-hover:text-green-700 group-hover:translate-x-1 transition-all duration-300">
                    <i class="fas fa-arrow-right text-sm"></i>
                  </div>
                </div>
              </a>
            </div>
          </div><!-- Navigation Links -->
          <div class="flex-1 px-2">
            <div class="nav-section-header">
              <i class="fas fa-compass mr-2 text-indigo-600"></i>
              Main Navigation
            </div>

            <nav class="space-y-1">
              <a
                href="{{ url_for('student.dashboard') }}"
                class="sidebar-item flex items-center px-4 py-3 group {% if request.endpoint == 'student.dashboard' %}active-nav{% else %}text-gray-700 hover:text-blue-700{% endif %}"
              >
                <div class="w-8 flex justify-center">
                  <i class="fas fa-tachometer-alt text-lg group-hover:scale-110 transition-transform duration-200"></i>
                </div>
                <span class="ml-3 font-medium">Dashboard</span>
                {% if request.endpoint == 'student.dashboard' %}
                <span class="ml-auto">
                  <i class="fas fa-circle text-xs animate-pulse"></i>
                </span>
                {% endif %}
              </a>

              <a
                href="{{ url_for('student.inquiries') }}"
                class="sidebar-item flex items-center px-4 py-3 group {% if request.endpoint == 'student.inquiries' %}active-nav{% else %}text-gray-700 hover:text-blue-700{% endif %}"
              >
                <div class="w-8 flex justify-center">
                  <i class="fas fa-question-circle text-lg group-hover:scale-110 transition-transform duration-200"></i>
                </div>
                <span class="ml-3 font-medium">My Inquiries</span>
                {% if pending_inquiries and pending_inquiries > 0 %}
                <span class="ml-auto counter-badge counter-red animate-bounce">
                  {{ pending_inquiries }}
                </span>
                {% elif request.endpoint == 'student.inquiries' %}
                <span class="ml-auto">
                  <i class="fas fa-circle text-xs animate-pulse"></i>
                </span>
                {% endif %}
              </a>              <a
                href="{{ url_for('student.counseling_dashboard') }}"
                class="sidebar-item flex items-center px-4 py-3 group {% if request.endpoint == 'student.counseling_dashboard' %}active-nav{% else %}text-gray-700 hover:text-blue-700{% endif %}"
              >
                <div class="w-8 flex justify-center">
                  <i class="fas fa-video text-lg group-hover:scale-110 transition-transform duration-200"></i>
                </div>
                <span class="ml-3 font-medium">My Counseling</span>
                {% if upcoming_sessions and upcoming_sessions > 0 %}
                <span class="ml-auto counter-badge counter-blue animate-pulse">
                  {{ upcoming_sessions }}
                </span>
                {% elif request.endpoint == 'student.counseling_dashboard' %}
                <span class="ml-auto">
                  <i class="fas fa-circle text-xs animate-pulse"></i>
                </span>
                {% endif %}
              </a>

              <a
                href="{{ url_for('student.announcements') }}"
                class="sidebar-item flex items-center px-4 py-3 group {% if request.endpoint == 'student.announcements' %}active-nav{% else %}text-gray-700 hover:text-blue-700{% endif %}"
              >
                <div class="w-8 flex justify-center">
                  <i class="fas fa-bullhorn text-lg group-hover:scale-110 transition-transform duration-200"></i>
                </div>
                <span class="ml-3 font-medium">Announcements</span>
                {% if request.endpoint == 'student.announcements' %}
                <span class="ml-auto">
                  <i class="fas fa-circle text-xs animate-pulse"></i>
                </span>
                {% endif %}
              </a>

              <a
                href="{{ url_for('student.university_offices') }}"
                class="sidebar-item flex items-center px-4 py-3 group {% if request.endpoint == 'student.university_offices' %}active-nav{% else %}text-gray-700 hover:text-blue-700{% endif %}"
              >
                <div class="w-8 flex justify-center">
                  <i class="fas fa-building text-lg group-hover:scale-110 transition-transform duration-200"></i>
                </div>
                <span class="ml-3 font-medium">University Offices</span>
                {% if request.endpoint == 'student.university_offices' %}
                <span class="ml-auto">
                  <i class="fas fa-circle text-xs animate-pulse"></i>
                </span>
                {% endif %}
              </a>
            </nav>
          </div>          <!-- Footer section -->
          <div class="p-4 border-t border-gray-200 bg-gradient-to-r from-gray-50 to-gray-100">
            <div class="text-center">
              <div class="text-xs text-gray-500 mb-2">
                <i class="fas fa-clock mr-1"></i>
                Last Login
              </div>
              <div class="text-sm text-gray-700 font-medium">
                {% if current_user.last_activity %} 
                {{ current_user.last_activity.strftime('%b %d, %Y') }}
                <br>
                <span class="text-xs text-gray-500">{{ current_user.last_activity.strftime('%I:%M %p') }}</span>
                {% else %} 
                <span class="text-blue-600">First Login</span>
                {% endif %}
              </div>
              <div class="mt-3 pt-2 border-t border-gray-200">
                <div class="flex items-center justify-center space-x-4 text-xs text-gray-400">
                  <span title="Connected"><i class="fas fa-wifi text-green-500"></i></span>
                  <span title="Version">v2.1.1</span>
                  <span title="Support"><i class="fas fa-question-circle"></i></span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </aside>      <!-- Mobile Sidebar Overlay -->
      <div
        class="fixed inset-0 bg-black/50 z-30 hidden md:hidden"
        id="sidebarOverlay"
        aria-hidden="true"
      ></div>

  <!-- Main Content -->
  <main class="flex-1 min-w-0 overflow-x-hidden overflow-y-auto main-content">
        <div class="container mx-auto px-4 py-6">
          <!-- Flash Messages -->
          {% with messages = get_flashed_messages(with_categories=true) %} {% if
          messages %} 
          <div class="mb-6">
            {% for category, message in messages %}
            <div
              class="mb-3 border-l-4 p-4 rounded-lg shadow-lg backdrop-blur-sm transition-all duration-300 {% if category == 'success' %}border-green-500 bg-gradient-to-r from-green-50 to-green-100 text-green-800 {% elif category == 'error' %}border-red-500 bg-gradient-to-r from-red-50 to-red-100 text-red-800 {% elif category == 'warning' %}border-yellow-500 bg-gradient-to-r from-yellow-50 to-yellow-100 text-yellow-800 {% else %}border-blue-500 bg-gradient-to-r from-blue-50 to-blue-100 text-blue-800{% endif %}"
              role="alert"
            >
              <div class="flex items-start">
                <!-- Icon based on category -->
                <div class="flex-shrink-0 mr-3 mt-0.5">
                  {% if category == 'success' %}
                  <div class="w-6 h-6 rounded-full bg-green-500 flex items-center justify-center">
                    <i class="fas fa-check text-white text-xs"></i>
                  </div>
                  {% elif category == 'error' %}
                  <div class="w-6 h-6 rounded-full bg-red-500 flex items-center justify-center">
                    <i class="fas fa-exclamation text-white text-xs"></i>
                  </div>
                  {% elif category == 'warning' %}
                  <div class="w-6 h-6 rounded-full bg-yellow-500 flex items-center justify-center">
                    <i class="fas fa-exclamation-triangle text-white text-xs"></i>
                  </div>
                  {% else %}
                  <div class="w-6 h-6 rounded-full bg-blue-500 flex items-center justify-center">
                    <i class="fas fa-info text-white text-xs"></i>
                  </div>
                  {% endif %}
                </div>
                <div class="flex-1">
                  <p class="font-medium">{{ message }}</p>
                </div>
                <button
                  class="flex-shrink-0 ml-3 text-gray-400 hover:text-gray-600 transition-colors duration-200"
                  onclick="this.parentElement.parentElement.remove()"
                >
                  <i class="fas fa-times"></i>
                </button>
              </div>
            </div>
            {% endfor %}
          </div>
          {% endif %} {% endwith %} 

          <!-- Main Content Area -->
          {% block content %}{% endblock %}
        </div>
      </main>
    </div>

    <!-- Audio for notifications -->
    <audio id="notification-sound" preload="auto" style="display: none">
      <source src="{{ url_for('static', filename='sounds/notification.mp3') }}" type="audio/mpeg" />
    </audio>

    <!-- Reminder Popup Modal -->
    <div id="reminderModal" class="fixed inset-0 z-50 hidden" role="dialog" aria-modal="true" aria-labelledby="reminderTitle" aria-describedby="reminderMessage">
      <div class="absolute inset-0 bg-black/40 backdrop-blur-sm"></div>
      <div class="relative h-full w-full flex items-center justify-center p-4">
        <div class="w-full max-w-md rounded-xl bg-white shadow-2xl ring-1 ring-black/5 overflow-hidden">
          <div class="px-5 py-4 bg-gradient-to-r from-blue-600 to-indigo-600 text-white flex items-center justify-between">
            <div class="flex items-center gap-2">
              <div class="w-8 h-8 rounded-full bg-white/20 flex items-center justify-center">
                <i class="fas fa-bell"></i>
              </div>
              <h3 id="reminderTitle" class="font-semibold">Session Reminder</h3>
            </div>
            <button id="reminderCloseBtn" class="text-white/80 hover:text-white" aria-label="Close reminder dialog">
              <i class="fas fa-times"></i>
            </button>
          </div>
          <div class="px-5 py-4">
            <p id="reminderMessage" class="text-gray-700"></p>
          </div>
          <div class="px-5 py-4 bg-gray-50 flex items-center justify-end gap-2">
            <button id="reminderDismissBtn" class="px-4 py-2 rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-100">Dismiss</button>
            <a id="reminderActionLink" href="#" class="px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700">Open</a>
          </div>
        </div>
      </div>
    </div>

    <!-- Announcement Details Modal -->
    <div id="announcementModal" class="fixed inset-0 z-50 hidden" role="dialog" aria-modal="true" aria-labelledby="announcementTitle">
      <div class="absolute inset-0 bg-black/40 backdrop-blur-sm"></div>
      <div class="relative h-full w-full flex items-center justify-center p-4">
        <div class="w-full max-w-2xl rounded-xl bg-white shadow-2xl ring-1 ring-black/5 overflow-hidden">
          <div class="px-5 py-4 bg-gradient-to-r from-indigo-600 to-blue-600 text-white flex items-center justify-between">
            <div class="flex items-center gap-2">
              <div class="w-8 h-8 rounded-full bg-white/20 flex items-center justify-center">
                <i class="fas fa-bullhorn"></i>
              </div>
              <div>
                <div id="announcementHeaderOffice" class="text-xs text-white/80"></div>
                <h3 id="announcementTitle" class="font-semibold">Announcement</h3>
              </div>
            </div>
            <button id="announcementCloseBtn" class="text-white/80 hover:text-white" aria-label="Close announcement dialog">
              <i class="fas fa-times"></i>
            </button>
          </div>
          <div class="px-5 py-4 space-y-3">
            <div id="announcementMeta" class="text-xs text-gray-500 flex flex-wrap items-center gap-3"></div>
            <div id="announcementContent" class="prose max-w-none text-gray-800"></div>
            <div id="announcementImages" class="grid grid-cols-2 md:grid-cols-3 gap-2"></div>
          </div>
          <div class="px-5 py-4 bg-gray-50 flex items-center justify-end gap-2">
            <a id="announcementOpenPage" href="#" class="px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700">Open Full Page</a>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Office-style notification/ toast CSS (minimal reuse via class names used above)
      const studentNotifStyles = document.createElement('style');
      studentNotifStyles.textContent = `
        #student-ann-bell-wrapper { position: relative; z-index: 1000; }
        #student-ann-dropdown { backdrop-filter: saturate(1.2) blur(8px); box-shadow: 0 8px 24px -4px rgba(17,24,39,0.15), 0 4px 12px -2px rgba(17,24,39,0.08); transform-origin: top right; opacity:0; transform: translateY(-8px) scale(.96); transition: opacity .28s cubic-bezier(.4,0,.2,1), transform .32s cubic-bezier(.4,0,.2,1); }
        #student-ann-dropdown.open { opacity:1; transform: translateY(0) scale(1); }
        #student-ann-dropdown.closing { opacity:0; transform: translateY(-6px) scale(.95); pointer-events:none; }
        .office-ann-item { position:relative; display:flex; gap:.75rem; }
        .office-ann-item .icon-pill { flex-shrink:0; width:38px; height:38px; border-radius:12px; display:flex; align-items:center; justify-content:center; font-size:.85rem; font-weight:600; }
        .office-ann-item.unread { background:linear-gradient(90deg, rgba(59,130,246,0.10), rgba(99,102,241,0)); }
        .office-ann-item:hover { background:linear-gradient(90deg, rgba(59,130,246,0.16), rgba(99,102,241,0.04)); }
        .office-ann-item .ann-body { flex:1; min-width:0; }
        .office-ann-item .ann-title { font-weight:600; font-size:.78rem; line-height:1.1rem; color:#1f2937; letter-spacing:.3px; }
        .office-ann-item .ann-msg { font-size:.67rem; color:#4b5563; line-height:1rem; margin-top:2px; }
        .office-ann-item .ann-meta { font-size:.6rem; color:#9ca3af; margin-top:4px; display:flex; align-items:center; gap:4px; text-transform:uppercase; font-weight:500; letter-spacing:.5px; }
        .office-ann-empty { padding:3.5rem 1.25rem; text-align:center; }
        .toast-zone { position:fixed; top:5rem; right:1.25rem; display:flex; flex-direction:column; gap:.75rem; z-index:70; width:clamp(260px, 30vw, 380px); pointer-events:none; }
        .toast { position:relative; background:#ffffff; border-radius:18px; padding:.9rem 1rem 1rem 1rem; box-shadow:0 10px 25px -5px rgba(17,24,39,0.18), 0 4px 10px -3px rgba(17,24,39,0.08); display:flex; gap:.85rem; transform:translateX(40px) scale(.96); opacity:0; animation:toastIn .55s cubic-bezier(.68,-0.55,.27,1.55) forwards; border:1px solid #e5e7eb; backdrop-filter:saturate(1.2) blur(6px); pointer-events:auto; }
        .toast.closing { animation:toastOut .35s ease forwards; }
        .toast .toast-icon-wrapper { position:relative; width:42px; height:42px; border-radius:14px; display:flex; align-items:center; justify-content:center; color:#fff; font-size:1.05rem; font-weight:600; box-shadow:0 4px 12px -2px rgba(0,0,0,.2); }
        .toast.type-info { --bar-color:#3b82f6; --bar-color-alt:#1d4ed8; }
        .toast.type-success { --bar-color:#10b981; --bar-color-alt:#059669; }
        .toast.type-warning { --bar-color:#f59e0b; --bar-color-alt:#d97706; }
        .toast.type-error { --bar-color:#ef4444; --bar-color-alt:#dc2626; }
        .toast .progress-bar { position:absolute; left:8px; right:8px; bottom:6px; height:4px; border-radius:2px; overflow:hidden; background:#e5e7eb; }
        .toast .progress-fill { height:100%; width:100%; transform-origin:left; animation:toastProgress linear forwards; background:linear-gradient(90deg,var(--bar-color,#3b82f6),var(--bar-color-alt,#1d4ed8)); }
        @keyframes toastIn { 0% { opacity:0; transform:translateX(50px) scale(.9); } 60% { opacity:1; transform:translateX(-4px) scale(1.02); } 100% { opacity:1; transform:translateX(0) scale(1); } }
        @keyframes toastOut { 0% { opacity:1; transform:translateX(0) scale(1); } 100% { opacity:0; transform:translateX(40px) scale(.9); } }
        @keyframes toastProgress { from { transform:scaleX(1); } to { transform:scaleX(0); } }
      `;
      document.head.appendChild(studentNotifStyles);

      document.addEventListener("DOMContentLoaded", function () {
        // Prime notification audio to satisfy autoplay policies
        const notifAudio = document.getElementById('notification-sound');
        const primeAudio = () => {
          if (!notifAudio) return;
          try {
            const p = notifAudio.play();
            if (p && typeof p.then === 'function') {
              p.then(() => { notifAudio.pause(); notifAudio.currentTime = 0; })
               .catch(() => {});
            } else {
              notifAudio.pause();
              notifAudio.currentTime = 0;
            }
          } catch(_) {}
          document.removeEventListener('click', primeAudio, true);
          document.removeEventListener('touchstart', primeAudio, true);
        };
        document.addEventListener('click', primeAudio, true);
        document.addEventListener('touchstart', primeAudio, true);
        // Reminder modal helpers
        const reminderModal = document.getElementById("reminderModal");
        const reminderTitleEl = document.getElementById("reminderTitle");
        const reminderMessageEl = document.getElementById("reminderMessage");
        const reminderActionLink = document.getElementById("reminderActionLink");
        const reminderCloseBtn = document.getElementById("reminderCloseBtn");
        const reminderDismissBtn = document.getElementById("reminderDismissBtn");

        function showReminderModal(data) {
          // Only show for reminder-type notifications
          if (!data || data.notification_type !== "reminder") return;
          reminderTitleEl.textContent = data.title || "Session Reminder";
          reminderMessageEl.textContent = data.message || "You have an upcoming session.";
          if (data.link) {
            reminderActionLink.href = data.link;
            reminderActionLink.classList.remove("hidden");
          } else {
            reminderActionLink.href = "#";
            reminderActionLink.classList.add("hidden");
          }
          reminderModal.classList.remove("hidden");
        }

        function hideReminderModal() {
          reminderModal.classList.add("hidden");
        }

        if (reminderCloseBtn) reminderCloseBtn.addEventListener("click", hideReminderModal);
        if (reminderDismissBtn) reminderDismissBtn.addEventListener("click", hideReminderModal);
        // Close when clicking backdrop
        if (reminderModal) {
          reminderModal.addEventListener("click", function (e) {
            if (e.target === reminderModal || e.target.classList.contains("backdrop-blur-sm")) {
              hideReminderModal();
            }
          });
        }
        // Mobile menu toggle and responsive handling
        const mobileMenuBtn = document.getElementById("mobileMenuBtn");
        const sidebar = document.getElementById("sidebar");
        const sidebarOverlay = document.getElementById("sidebarOverlay");

        const isMobile = () => window.matchMedia('(max-width: 767.98px)').matches;

  const openSidebar = () => {
          // Prepare for animation
          sidebar.classList.remove('hidden');
          sidebarOverlay.classList.remove('hidden');
          requestAnimationFrame(() => {
            sidebar.classList.remove('-translate-x-full');
            mobileMenuBtn.setAttribute('aria-expanded', 'true');
            document.body.style.overflow = 'hidden';
          });
        };

        const closeSidebar = () => {
          sidebar.classList.add('-translate-x-full');
          mobileMenuBtn.setAttribute('aria-expanded', 'false');
          document.body.style.overflow = '';
          // Hide after transition completes
          setTimeout(() => {
            if (isMobile()) {
              sidebar.classList.add('hidden');
              sidebarOverlay.classList.add('hidden');
            } else {
              sidebar.classList.remove('hidden');
              sidebarOverlay.classList.add('hidden');
            }
          }, 250);
        };

        // Ensure correct initial state
    const setInitialSidebarState = () => {
          if (isMobile()) {
            sidebar.classList.add('hidden', '-translate-x-full', 'fixed', 'inset-y-0', 'left-0');
            sidebarOverlay.classList.add('hidden');
            mobileMenuBtn.setAttribute('aria-expanded', 'false');
          } else {
      sidebar.classList.remove('hidden', '-translate-x-full');
      sidebar.classList.add('md:translate-x-0');
            sidebarOverlay.classList.add('hidden');
            mobileMenuBtn.setAttribute('aria-expanded', 'false');
          }
        };

        setInitialSidebarState();

        mobileMenuBtn.addEventListener('click', function () {
          if (sidebar.classList.contains('hidden') || sidebar.classList.contains('-translate-x-full')) {
            openSidebar();
          } else {
            closeSidebar();
          }
        });

        sidebarOverlay.addEventListener('click', closeSidebar);

        // Close button inside sidebar (mobile only visible)
        const sidebarCloseBtn = document.getElementById('sidebarCloseBtn');
        if (sidebarCloseBtn) {
          sidebarCloseBtn.addEventListener('click', closeSidebar);
        }

        // Handle viewport resize to avoid stuck states
        let resizeTimeout;
        window.addEventListener('resize', function () {
          clearTimeout(resizeTimeout);
          resizeTimeout = setTimeout(() => {
            setInitialSidebarState();
          }, 150);
        });

        // Student unified dropdown open/close (office-style)
        (function(){
          const bellBtn = document.getElementById('student-ann-bell');
          const dropdown = document.getElementById('student-ann-dropdown');
          const list = document.getElementById('student-ann-list');
          const badge = document.getElementById('student-ann-badge');
          const markAll = document.getElementById('student-ann-mark-all');
          const refreshBtn = document.getElementById('student-ann-refresh');

          // Toast zone shared
          let toastZone = document.querySelector('.toast-zone');
          if(!toastZone){ toastZone = document.createElement('div'); toastZone.className='toast-zone'; document.body.appendChild(toastZone); }

          function escapeHtml(str){ return (str||'').replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c])); }
          function formatPHT(input){
            try{
              let d;
              if(!input){ d = new Date(); }
              else if(typeof input === 'number'){ d = new Date(input); }
              else if(typeof input === 'string'){
                const t = Date.parse(input);
                d = isNaN(t) ? new Date() : new Date(t);
              } else if(input instanceof Date){ d = input; } else { d = new Date(); }
              const opts = { timeZone: 'Asia/Manila', month: 'short', day: '2-digit', hour: '2-digit', minute:'2-digit', hour12: true };
              const parts = new Intl.DateTimeFormat('en-US', opts).formatToParts(d);
              const map = Object.fromEntries(parts.map(p=>[p.type,p.value]));
              return `${map.month} ${map.day}, ${map.hour}:${map.minute} ${map.dayPeriod}`;
            }catch(_){ return new Date().toLocaleString('en-US', { hour:'2-digit', minute:'2-digit', hour12:true }); }
          }
          function incrementBadge(){ if (!badge) return; let n=parseInt(badge.textContent||'0'); n+=1; badge.textContent=String(n); badge.classList.remove('hidden'); }
          function setBadgeCount(n){ if(!badge) return; if(n<=0){badge.textContent='0'; badge.classList.add('hidden');} else {badge.textContent=String(n); badge.classList.remove('hidden');} }
          function buildItem(data){
            const a = document.createElement('a');
            const href = data.inquiry_id ? `/student/inquiry/${data.inquiry_id}` : (data.announcement_id ? `/student/announcement/${data.announcement_id}` : (data.link || "{{ url_for('student.notifications') }}"));
            a.href = href; a.className='office-ann-item unread px-4 py-3 transition-colors'; a.dataset.id = data.id || data.notification_id || '';
            if (data.announcement_id) a.dataset.announcementId = String(data.announcement_id);
            const ts = formatPHT(data.created_at || data.timestamp || Date.now());
            const source = escapeHtml(data.target_office_name || data.posted_by_office_name || 'Announcement');
            const title = escapeHtml(data.title||'Notification');
            const msg = escapeHtml(data.message||'');
            a.innerHTML = `
              <div class="icon-pill bg-gradient-to-br from-blue-600 to-indigo-600 text-white shadow-inner"><i class="fa-solid fa-bell"></i></div>
              <div class="ann-body">
                <div class="ann-title">${source ? source + ' â€” ' : ''}${title}</div>
                <div class="ann-msg line-clamp-2">${msg}</div>
                <div class="ann-meta"><i class="fas fa-clock"></i>${ts}</div>
              </div>`; return a;
          }
          function prependItem(data){ if(!list) return; const el = buildItem(data); list.prepend(el); }

          function showToast({title='Notification', message='', type='info', duration=6500, link=null}){
            const t = document.createElement('div');
            t.className = `toast type-${type}`; t.setAttribute('role','alert'); t.setAttribute('aria-live','polite');
            const iconMap = { info:'fa-bell', success:'fa-check', warning:'fa-exclamation', error:'fa-times' };
            const icon = iconMap[type] || iconMap.info;
            const progress = `<div class="progress-bar"><div class="progress-fill" style="animation-duration:${duration}ms"></div></div>`;
            t.innerHTML = `
              <div class="toast-icon-wrapper" style="background:linear-gradient(135deg,var(--bar-color),var(--bar-color-alt));">
                <i class="fa-solid ${icon} toast-icon"></i>
              </div>
              <div class="toast-content">
                <div class="toast-title">${escapeHtml(title)}</div>
                <div class="toast-message">${escapeHtml(message)}</div>
              </div>
              <button class="toast-close" aria-label="Close notification">&times;</button>
              ${progress}`;
            if(link){ t.classList.add('cursor-pointer'); t.addEventListener('click', (ev)=>{ if(ev.target.closest('.toast-close')) return; window.location.href = link; }); }
            const close = ()=>{ if(t.classList.contains('closing')) return; t.classList.add('closing'); setTimeout(()=>t.remove(),340); };
            t.querySelector('.toast-close').addEventListener('click', close);
            setTimeout(close, duration+200);
            toastZone.appendChild(t);
            return t;
          }

          function openDropdown(){ if(!dropdown || dropdown.classList.contains('open')) return; dropdown.classList.remove('hidden','closing'); requestAnimationFrame(()=>dropdown.classList.add('open')); }
          function closeDropdown(){ if(!dropdown || dropdown.classList.contains('hidden')) return; dropdown.classList.add('closing'); dropdown.classList.remove('open'); setTimeout(()=>dropdown.classList.add('hidden'),220); }
          if(bellBtn){
            bellBtn.addEventListener('click', (e)=>{ e.stopPropagation(); dropdown.classList.contains('open')?closeDropdown():openDropdown(); });
            document.addEventListener('click', (e)=>{ if(dropdown && !dropdown.contains(e.target) && !bellBtn.contains(e.target)) closeDropdown(); });
            document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeDropdown(); });
          }

          // Announcement modal support
          const annModal = document.getElementById('announcementModal');
          const annClose = document.getElementById('announcementCloseBtn');
          const annHeaderOffice = document.getElementById('announcementHeaderOffice');
          const annTitle = document.getElementById('announcementTitle');
          const annMeta = document.getElementById('announcementMeta');
          const annContent = document.getElementById('announcementContent');
          const annImages = document.getElementById('announcementImages');
          const annOpenPage = document.getElementById('announcementOpenPage');

          function openAnnouncementModal(announcementId){
            if(!announcementId) return false;
            fetch(`/student/api/announcement/${announcementId}`)
              .then(async res => {
                if(!res.ok){ throw new Error('Fetch failed'); }
                return res.json();
              })
              .then(data => {
                // Populate modal
                const officeBits = [data.office_name || data.posted_by_office_name || '', data.campus_name || ''].filter(Boolean);
                annHeaderOffice.textContent = officeBits.join(' â€¢ ');
                annTitle.textContent = data.title || 'Announcement';
                const meta = [];
                if (data.author_name) meta.push(`${data.author_name}${data.author_role? ' ('+data.author_role.replace(/_/g,' ')+')':''}`);
                if (data.created_at) meta.push(new Date(data.created_at).toLocaleString());
                annMeta.textContent = meta.join(' â€¢ ');
                annContent.innerHTML = '';
                const p = document.createElement('p'); p.textContent = data.content || ''; annContent.appendChild(p);
                annImages.innerHTML='';
                if (Array.isArray(data.images)){
                  data.images.forEach(img => {
                    if(!img || !img.url) return;
                    const a = document.createElement('a'); a.href = img.url; a.target='_blank'; a.rel='noopener';
                    const im = document.createElement('img'); im.src = img.url; im.alt = img.caption||'Announcement image'; im.className='w-full h-28 object-cover rounded-lg border';
                    a.appendChild(im);
                    annImages.appendChild(a);
                  });
                }
                annOpenPage.href = data.link || `/student/announcement/${announcementId}`;
                annModal.classList.remove('hidden');
              })
              .catch(() => { window.location.href = `/student/announcement/${announcementId}`; });
            return true;
          }

          function closeAnnouncementModal(){ annModal.classList.add('hidden'); }
          if(annClose) annClose.addEventListener('click', closeAnnouncementModal);
          if(annModal){ annModal.addEventListener('click', (e)=>{ if(e.target===annModal || e.target.classList.contains('backdrop-blur-sm')) closeAnnouncementModal(); }); }

          if(list){
            list.addEventListener('click', async (e)=>{
              const a = e.target.closest('.office-ann-item');
              if(!a) return;
              // Intercept announcement click to open modal
              const annId = a.dataset.announcementId;
              if(annId){ e.preventDefault(); openAnnouncementModal(annId); }

              if(a.classList.contains('unread')){
                a.classList.remove('unread');
                const id = a.dataset.id;
                if(badge && !badge.classList.contains('hidden')){ let n=parseInt(badge.textContent||'0'); n=isNaN(n)?0:Math.max(0,n-1); setBadgeCount(n); }
                if(id){ try { await fetch(`/student/notifications/mark-read/${id}`, {method:'POST', headers:{'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content}});} catch(err){} }
              }
            });
          }

          if(markAll){
            markAll.addEventListener('click', async ()=>{
              try{
                const res = await fetch('/student/notifications/mark-all-read', {method:'POST', headers:{'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content}});
                if(!res.ok) return showToast({title:'Error', message:'Request failed', type:'error', duration:4000});
                const data = await res.json();
                list.querySelectorAll('.office-ann-item.unread').forEach(a=>a.classList.remove('unread'));
                setBadgeCount(0);
                showToast({title:'All read', message:data.message || 'Marked as read', type:'success', duration:3000});
              }catch(e){ showToast({title:'Error', message:'Could not update', type:'error'}); }
            });
          }

          if(refreshBtn){
            refreshBtn.addEventListener('click', async ()=>{
              refreshBtn.disabled = true; const prev = refreshBtn.textContent; refreshBtn.textContent='...';
              try{
                const res = await fetch('/student/notifications/get-unread-count');
                if(res.ok){
                  // Soft refresh: only update badge
                  const data = await res.json(); setBadgeCount(parseInt(data.unread_count||0));
                  showToast({title:'Refreshed', message:'Badge updated.', type:'info', duration:2000});
                }
              } finally { refreshBtn.disabled=false; refreshBtn.textContent=prev; }
            });
          }

          // Socket wiring for student notifications
          try{
            const socket = io();
            socket.on('connect', ()=>{ try{ socket.emit('join', { room: `student_{{ current_user.id }}` }); }catch(_){} });
            socket.on('new_notification', data => {
              try{ document.getElementById('notification-sound')?.play().catch(()=>{});}catch(_){ }
              incrementBadge();
              prependItem(data);
              const kind = (data.notification_type||data.type||'').toLowerCase();
              let toastType = 'info';
              if(/success|scheduled|ready/.test(kind)) toastType='success';
              else if(/warning|reminder/.test(kind)) toastType='warning';
              else if(/error|fail/.test(kind)) toastType='error';
              const link = data.inquiry_id ? `/student/inquiry/${data.inquiry_id}` : (data.announcement_id ? `/student/announcement/${data.announcement_id}` : (data.link || null));
              let title = data.title || 'Notification';
              let message = data.message || '';
              if(message.length>180) message = message.slice(0,177)+'â€¦';
              showToast({title, message, type:toastType, duration: kind==='reminder'?8000:6500, link});
            });

            // Realtime updates when notifications are marked as read from chat views
            socket.on('notification_update', data => {
              try{
                const c = parseInt((data&&data.count)||1);
                const badge = document.getElementById('student-ann-badge');
                if (badge) {
                  let n = parseInt(badge.textContent||'0');
                  n = isNaN(n)?0:Math.max(0, n - c);
                  badge.textContent = String(n);
                  if (n <= 0) badge.classList.add('hidden'); else badge.classList.remove('hidden');
                }
              }catch(_){ }
            });
          }catch(e){}
        })();

    // User avatar dropdown: avatar toggles the menu directly (caret removed)
        (function(){
          const menuToggle = document.getElementById('userMenuToggle');
          const menu = document.getElementById('userMenu');
          const dropdown = document.getElementById('userDropdown');
          if(!menu || !menuToggle || !dropdown) return;

          function openMenu(){
            menu.style.display = 'block';
            menu.style.animation = 'fadeInUp 160ms ease-out';
            menuToggle.setAttribute('aria-expanded','true');
          }
          function closeMenu(){
            menu.style.display = 'none';
            menuToggle.setAttribute('aria-expanded','false');
          }
          function isOpen(){ return menu.style.display !== 'none' && menu.style.display !== ''; }

          // Initialize hidden
          closeMenu();

          menuToggle.addEventListener('click', (e)=>{
            e.stopPropagation();
            isOpen() ? closeMenu() : openMenu();
          });

          // Close on outside click or ESC
          document.addEventListener('click', (e)=>{
            if (!dropdown.contains(e.target)) closeMenu();
          });
          document.addEventListener('keydown', (e)=>{
            if (e.key === 'Escape') closeMenu();
          });

          // Close menu when a menu item is clicked
          menu.querySelectorAll('a, button').forEach(el => {
            el.addEventListener('click', () => closeMenu());
          });
        })();

        // Handle notification clicks - redirect to inquiry
        const notificationItems = document.querySelectorAll(".notification-item");
        notificationItems.forEach((item) => {
          item.addEventListener("click", function (e) {
            // Don't navigate if clicked on close button
            if (e.target.closest(".notification-close")) {
              return;
            }

            // Get inquiry ID and navigate if available
            const inquiryId = this.dataset.inquiryId;
            const announcementId = this.dataset.announcementId;
            if (inquiryId) {
              // Mark as read before navigating
              fetch(`/student/api/notifications/${this.dataset.notificationId}/dismiss`, {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                  "X-CSRFToken": document.querySelector('meta[name="csrf-token"]')?.getAttribute("content") || "",
                },
              })
                .then(() => {
                  window.location.href = `/student/inquiry/${inquiryId}`;
                })
                .catch((error) => {
                  console.error("Error marking notification as read:", error);
                  window.location.href = `/student/inquiry/${inquiryId}`;
                });
            } else if (announcementId) {
              fetch(`/student/api/notifications/${this.dataset.notificationId}/dismiss`, {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                  "X-CSRFToken": document.querySelector('meta[name="csrf-token"]')?.getAttribute("content") || "",
                },
              })
                .then(() => {
                  window.location.href = `/student/announcement/${announcementId}`;
                })
                .catch((error) => {
                  console.error("Error marking notification as read:", error);
                  window.location.href = `/student/announcement/${announcementId}`;
                });
            }
          });
        });

        // Handle notification dismiss buttons
        const closeButtons = document.querySelectorAll(".notification-close");
        closeButtons.forEach((button) => {
          button.addEventListener("click", function (e) {
            e.preventDefault();
            e.stopPropagation();
            const notificationItem = this.closest(".notification-item");
            const notificationId = notificationItem.dataset.notificationId;

            // Mark as read in the database via fetch API
            fetch(`/student/api/notifications/${notificationId}/dismiss`, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": document.querySelector('meta[name="csrf-token"]')?.getAttribute("content") || "",
              },
            })
              .then((response) => {
                if (!response.ok) {
                  throw new Error("Network response was not ok");
                }
                return response.json();
              })
              .then((data) => {
                if (data.success) {
                  // Remove the notification from UI
                  notificationItem.style.height = notificationItem.offsetHeight + "px";
                  setTimeout(() => {
                    notificationItem.style.height = "0";
                    notificationItem.style.padding = "0";
                    notificationItem.style.margin = "0";
                    notificationItem.style.opacity = "0";
                    notificationItem.style.overflow = "hidden";
                  }, 10);

                  // Remove from DOM after animation completes
                  setTimeout(() => {
                    notificationItem.remove();

                    // Update badge count
                    const badges = document.querySelectorAll(".notification-badge");
                    badges.forEach(badge => {
                      let count = parseInt(badge.textContent || "0");
                      if (count > 0) {
                        count--;
                        if (count === 0) {
                          badge.classList.add("hidden");
                        } else {
                          badge.textContent = count;
                        }
                      }
                    });

                    // Show "no notifications" message if this was the last one
                    const container = document.getElementById("notificationsContainer");
                    if (container && !container.querySelector(".notification-item")) {
                      container.innerHTML = `
                        <div class="p-3 text-center text-gray-500">
                          <i class="far fa-bell-slash text-gray-300 text-lg mb-2"></i>
                          <p>No notifications</p>
                        </div>
                      `;
                    }
                  }, 300);
                }
              })
              .catch((error) => console.error("Error dismissing notification:", error));
          });
        });

        // Mark all as read functionality
        const markAllAsReadBtn = document.getElementById("markAllAsRead");
        if (markAllAsReadBtn) {
          markAllAsReadBtn.addEventListener("click", function (e) {
            e.preventDefault();
            fetch("/student/api/notifications/mark-all-read", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": document.querySelector('meta[name="csrf-token"]')?.getAttribute("content") || "",
              },
            })
              .then((response) => {
                if (!response.ok) {
                  throw new Error("Network response was not ok");
                }
                return response.json();
              })
              .then((data) => {
                if (data.success) {
                  // Update UI - remove 'unread' class from all notifications
                  document.querySelectorAll(".notification-item.unread").forEach((item) => {
                    item.classList.remove("unread");
                  });

                  // Hide the badge counter
                  const badges = document.querySelectorAll(".notification-badge");
                  badges.forEach(badge => {
                    badge.textContent = "0";
                    badge.classList.add("hidden");
                  });

                  // Show confirmation feedback
                  const container = document.getElementById("notificationsContainer");
                  const feedbackDiv = document.createElement("div");
                  feedbackDiv.className = "bg-green-50 text-green-700 text-xs text-center p-2 border-b border-green-100";
                  feedbackDiv.innerText = "All notifications marked as read";
                  container.prepend(feedbackDiv);

                  // Remove the feedback after 2 seconds
                  setTimeout(() => {
                    feedbackDiv.style.opacity = "0";
                    feedbackDiv.style.transition = "opacity 0.5s ease";
                    setTimeout(() => feedbackDiv.remove(), 500);
                  }, 2000);
                }
              })
              .catch((error) => console.error("Error marking notifications as read:", error));
          });
        }

  // (Socket connection handled above in the unified dropdown controller)

  // Reminder pop-up remains for reminder-type notifications
  // kept via showReminderModal(data) from earlier code if needed in future
      });
    </script>

    {% block scripts %}{% endblock %}
  </body>
</html>