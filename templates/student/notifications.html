{% extends "student/student_base.html" %}
{% block title %}Notifications - KapiyuGuide{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-6">
  <!-- Header -->
  <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl shadow-lg p-8 mb-8 border border-blue-100">
    <div class="flex items-center justify-between">
      <div class="flex items-center space-x-4">
        <div class="bg-blue-100 p-3 rounded-full">
          <i class="fas fa-bell text-blue-600 text-2xl"></i>
        </div>
        <div>
          <h1 class="text-3xl font-bold text-gray-800">Notifications</h1>
          <p class="text-gray-600 mt-1">Manage your announcements, replies, and updates</p>
        </div>
      </div>
      <div class="text-right">
  <div class="text-2xl font-bold text-blue-600">{{ total_notifications|default(0) }}</div>
        <div class="text-sm text-gray-500">Total Notifications</div>
      </div>
    </div>
  </div>

  <!-- Metrics -->
  <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
    <div class="bg-white rounded-xl shadow-lg border border-gray-100 p-6">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm text-gray-600 font-medium">Total</p>
          <p class="text-3xl font-bold text-blue-600">{{ total_notifications|default(0) }}</p>
        </div>
        <div class="bg-blue-100 p-3 rounded-full">
          <i class="fas fa-bell text-blue-600 text-xl"></i>
        </div>
      </div>
    </div>
    <div class="bg-white rounded-xl shadow-lg border border-gray-100 p-6">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm text-gray-600 font-medium">Unread</p>
          <p class="text-3xl font-bold text-red-600">{{ unread_count|default(0) }}</p>
        </div>
        <div class="bg-red-100 p-3 rounded-full">
          <i class="fas fa-exclamation-circle text-red-600 text-xl"></i>
        </div>
      </div>
    </div>
    <div class="bg-white rounded-xl shadow-lg border border-gray-100 p-6">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm text-gray-600 font-medium">Read</p>
          <p class="text-3xl font-bold text-green-600">{{ read_count|default(0) }}</p>
        </div>
        <div class="bg-green-100 p-3 rounded-full">
          <i class="fas fa-check-circle text-green-600 text-xl"></i>
        </div>
      </div>
    </div>
    <div class="bg-white rounded-xl shadow-lg border border-gray-100 p-6">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm text-gray-600 font-medium">Quick Actions</p>
          <div class="space-y-2 mt-2">
            {% if (unread_count|default(0)) > 0 %}
            <button id="markAllReadBtn" class="text-xs bg-blue-600 text-white px-3 py-1 rounded-full hover:bg-blue-700 transition-colors">Mark All Read</button>
            {% endif %}
            {% if (read_count|default(0)) > 0 %}
            <button id="deleteAllReadBtn" class="text-xs bg-red-600 text-white px-3 py-1 rounded-full hover:bg-red-700 transition-colors">Clear Read</button>
            {% endif %}
          </div>
        </div>
        <div class="bg-purple-100 p-3 rounded-full">
          <i class="fas fa-tasks text-purple-600 text-xl"></i>
        </div>
      </div>
    </div>
  </div>

  <!-- Filters -->
  <div class="bg-white rounded-xl shadow-lg p-6 mb-8 border border-gray-100">
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center space-y-4 md:space-y-0">
      <div>
        <h3 class="text-lg font-semibold text-gray-800 mb-2">Filter Notifications</h3>
        <p class="text-sm text-gray-600">Use filters to find specific notifications</p>
      </div>
      <div class="flex flex-wrap gap-4">
        <div class="flex flex-col">
          <label class="text-sm font-medium text-gray-700 mb-1">Status</label>
          <select id="readFilter" class="border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            <option value="">All</option>
            <option value="unread" {% if current_filter_read == 'unread' %}selected{% endif %}>Unread</option>
            <option value="read" {% if current_filter_read == 'read' %}selected{% endif %}>Read</option>
          </select>
        </div>
        <div class="flex flex-col">
          <label class="text-sm font-medium text-gray-700 mb-1">Type</label>
          <select id="typeFilter" class="border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            <option value="">All Types</option>
            <option value="inquiry_reply" {% if current_filter_type == 'inquiry_reply' %}selected{% endif %}>Inquiry Replies</option>
            <option value="announcement" {% if current_filter_type == 'announcement' %}selected{% endif %}>Announcements</option>
            <option value="status_change" {% if current_filter_type == 'status_change' %}selected{% endif %}>Status Changes</option>
            <option value="general" {% if current_filter_type == 'general' %}selected{% endif %}>General</option>
          </select>
        </div>
        <div class="flex flex-col justify-end">
          <button onclick="applyFilters()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors text-sm">
            <i class="fas fa-filter mr-2"></i>Apply Filters
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- List -->
  <div class="bg-white rounded-xl shadow-lg border border-gray-100 overflow-hidden">
    <div class="px-6 py-4 bg-gradient-to-r from-blue-600 to-indigo-600 text-white">
      <div class="flex justify-between items-center">
        <h2 class="text-xl font-bold">Your Notifications</h2>
        {% if pagination %}
        <div class="text-sm">Page {{ pagination.page }} of {{ pagination.pages }} ({{ pagination.total }} total)</div>
        {% endif %}
      </div>
    </div>

    <div class="divide-y divide-gray-200" id="notificationsContainer">
      {% if page_notifications %}
        {% for notification in page_notifications %}
     <div class="notification-item p-6 hover:bg-gray-50 transition-colors {% if not notification.is_read %}bg-blue-50 border-l-4 border-blue-500{% endif %}"
       data-notification-id="{{ notification.id }}"
       data-inquiry-id="{{ notification.inquiry_id if notification.inquiry_id }}"
       data-announcement-id="{{ notification.announcement_id if notification.announcement_id }}"
       data-link="{{ notification.link if notification.link }}">
          <div class="flex items-start space-x-4">
            <div class="flex-shrink-0 pt-1">
              {% if notification.notification_type == 'inquiry_reply' %}
                <div class="bg-blue-100 p-2 rounded-full"><i class="fas fa-reply text-blue-600 text-lg"></i></div>
              {% elif notification.notification_type == 'announcement' %}
                <div class="bg-green-100 p-2 rounded-full"><i class="fas fa-bullhorn text-green-600 text-lg"></i></div>
              {% elif notification.notification_type == 'status_change' %}
                <div class="bg-yellow-100 p-2 rounded-full"><i class="fas fa-sync-alt text-yellow-600 text-lg"></i></div>
              {% else %}
                <div class="bg-gray-100 p-2 rounded-full"><i class="fas fa-info-circle text-gray-600 text-lg"></i></div>
              {% endif %}
            </div>
            <div class="flex-grow min-w-0">
              <div class="flex justify-between items-start mb-2">
                <h3 class="text-lg font-semibold text-gray-800 truncate">{{ notification.title }}</h3>
                <div class="flex items-center space-x-2 ml-4">
                  <span class="text-xs text-gray-500 whitespace-nowrap">{{ notification.created_at|dt12 }}</span>
                  {% if not notification.is_read %}<span class="bg-red-500 text-white text-xs px-2 py-1 rounded-full">New</span>{% endif %}
                </div>
              </div>
              <div class="text-sm text-gray-600 mb-3">{{ notification.message }}</div>
              <div class="flex items-center justify-between">
                <div class="flex items-center space-x-2">
                  {% if notification.notification_type == 'inquiry_reply' %}
                    <span class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded-full">Inquiry Reply</span>
                  {% elif notification.notification_type == 'announcement' %}
                    <span class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded-full">Announcement</span>
                  {% elif notification.notification_type == 'status_change' %}
                    <span class="bg-yellow-100 text-yellow-800 text-xs px-2 py-1 rounded-full">Status Change</span>
                  {% else %}
                    <span class="bg-gray-100 text-gray-800 text-xs px-2 py-1 rounded-full">General</span>
                  {% endif %}
                </div>
                <div class="flex items-center space-x-2">
                  {% if notification.inquiry_id %}
                    <a href="{{ url_for('student.view_inquiry', inquiry_id=notification.inquiry_id) }}" class="text-xs bg-blue-600 text-white px-3 py-1 rounded-full hover:bg-blue-700 transition-colors">
                      <i class="fas fa-arrow-right mr-1"></i>View
                    </a>
                  {% elif notification.announcement_id %}
                    <a href="{{ url_for('student.view_announcement', announcement_id=notification.announcement_id) }}" class="text-xs bg-blue-600 text-white px-3 py-1 rounded-full hover:bg-blue-700 transition-colors">
                      <i class="fas fa-arrow-right mr-1"></i>View
                    </a>
                  {% elif notification.link %}
                    <a href="{{ notification.link }}" class="text-xs bg-blue-600 text-white px-3 py-1 rounded-full hover:bg-blue-700 transition-colors">
                      <i class="fas fa-arrow-right mr-1"></i>Open
                    </a>
                  {% endif %}
                  {% if not notification.is_read %}
                    <button onclick="markAsRead({{ notification.id }})" class="text-xs bg-green-600 text-white px-3 py-1 rounded-full hover:bg-green-700 transition-colors">
                      <i class="fas fa-check mr-1"></i>Mark Read
                    </button>
                  {% endif %}
                  <button onclick="deleteNotification({{ notification.id }})" class="text-xs bg-red-600 text-white px-3 py-1 rounded-full hover:bg-red-700 transition-colors">
                    <i class="fas fa-trash mr-1"></i>Delete
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
        {% endfor %}
      {% else %}
        <div class="p-12 text-center">
          <div class="bg-gray-100 p-6 rounded-full inline-block mb-4">
            <i class="fas fa-bell-slash text-gray-400 text-4xl"></i>
          </div>
          <h3 class="text-xl font-semibold text-gray-600 mb-2">No Notifications Found</h3>
          <p class="text-gray-500">You don't have any notifications matching the current filters.</p>
          {% if current_filter_read or current_filter_type %}
          <button onclick="clearFilters()" class="mt-4 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
            <i class="fas fa-filter mr-2"></i>Clear Filters
          </button>
          {% endif %}
        </div>
  {% endif %}
    </div>

    {% if pagination and pagination.pages > 1 %}
    <div class="px-6 py-4 bg-gray-50 border-t border-gray-200">
      <div class="flex justify-between items-center">
        <div class="text-sm text-gray-600">
          Showing {{ pagination.per_page * (pagination.page - 1) + 1 }} to {{ pagination.per_page * pagination.page if pagination.page < pagination.pages else pagination.total }} of {{ pagination.total }} notifications
        </div>
        <div class="flex space-x-2">
          {% if pagination.has_prev %}
          <a href="{{ url_for('student.notifications', page=pagination.prev_num, read=current_filter_read, type=current_filter_type) }}" class="px-3 py-2 text-sm bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
            <i class="fas fa-chevron-left mr-1"></i>Previous
          </a>
          {% endif %}
          {% for page_num in pagination.iter_pages() %}
            {% if page_num %}
              {% if page_num != pagination.page %}
                <a href="{{ url_for('student.notifications', page=page_num, read=current_filter_read, type=current_filter_type) }}" class="px-3 py-2 text-sm bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors">{{ page_num }}</a>
              {% else %}
                <span class="px-3 py-2 text-sm bg-blue-600 text-white rounded-lg">{{ page_num }}</span>
              {% endif %}
            {% else %}
              <span class="px-3 py-2 text-sm text-gray-500">…</span>
            {% endif %}
          {% endfor %}
          {% if pagination.has_next %}
          <a href="{{ url_for('student.notifications', page=pagination.next_num, read=current_filter_read, type=current_filter_type) }}" class="px-3 py-2 text-sm bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
            Next<i class="fas fa-chevron-right ml-1"></i>
          </a>
          {% endif %}
        </div>
      </div>
    </div>
    {% endif %}
  </div>
</div>

<!-- Confirmation Modal -->
<div id="confirmationModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
  <div class="bg-white rounded-xl shadow-2xl max-w-md w-full mx-4">
    <div class="p-6">
      <div class="flex items-center mb-4">
        <div class="bg-red-100 p-3 rounded-full mr-4">
          <i class="fas fa-exclamation-triangle text-red-600 text-xl"></i>
        </div>
        <h3 class="text-lg font-semibold text-gray-800">Confirm Action</h3>
      </div>
      <p id="confirmationMessage" class="text-gray-600 mb-6"></p>
      <div class="flex justify-end space-x-4">
        <button onclick="closeConfirmationModal()" class="px-4 py-2 text-gray-600 bg-gray-200 rounded-lg hover:bg-gray-300 transition-colors">Cancel</button>
        <button id="confirmActionBtn" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors">Confirm</button>
      </div>
    </div>
  </div>
    </div>
{% endblock %}

{% block scripts %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

    // Actions
    window.markAsRead = function(notificationId) {
      fetch(`/student/notifications/mark-read/${notificationId}`, {
        method: 'POST', headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken }
      }).then(r=>r.json()).then(data=>{
        if(data.success){
          const item = document.querySelector(`[data-notification-id="${notificationId}"]`);
          if(item){ item.classList.remove('bg-blue-50','border-l-4','border-blue-500');
            const badge = item.querySelector('.bg-red-500'); if(badge) badge.remove();
            const btn = item.querySelector('button[onclick*="markAsRead"]'); if(btn) btn.remove(); }
          showToast('Notification marked as read', 'success');
          setTimeout(()=>window.location.reload(), 800);
        } else {
          showToast('Failed to mark notification as read', 'error');
        }
      }).catch(()=>{ showToast('Failed to mark notification as read', 'error'); });
    }

    window.deleteNotification = function(notificationId){
      showConfirmationModal('Delete this notification? This cannot be undone.', ()=>{
        fetch(`/student/notifications/delete/${notificationId}`, {
          method:'DELETE', headers:{ 'Content-Type':'application/json','X-CSRFToken': csrfToken }
        }).then(r=>r.json()).then(data=>{
          if(data.success){
            const item = document.querySelector(`[data-notification-id="${notificationId}"]`);
            if(item) item.remove();
            showToast('Notification deleted', 'success');
            setTimeout(()=>window.location.reload(), 700);
          } else {
            showToast('Failed to delete notification', 'error');
          }
        }).catch(()=>{ showToast('Failed to delete notification', 'error'); });
      });
    }

    const markAllBtn = document.getElementById('markAllReadBtn');
    if(markAllBtn){ markAllBtn.addEventListener('click', function(){
      showConfirmationModal('Mark all notifications as read?', ()=>{
  fetch('/student/notifications/mark-all-read', { method:'POST', headers:{ 'Content-Type':'application/json','X-CSRFToken': csrfToken }})
  .then(r=>r.json()).then(data=>{ if(data.success){ showToast(data.message || 'Marked all as read', 'success'); setTimeout(()=>window.location.reload(), 800); } else { showToast('Failed to mark all as read', 'error'); } })
  .catch(()=>{ showToast('Failed to mark all as read', 'error'); });
      });
    });}

    const deleteAllBtn = document.getElementById('deleteAllReadBtn');
    if(deleteAllBtn){ deleteAllBtn.addEventListener('click', function(){
      showConfirmationModal('Delete all read notifications? This cannot be undone.', ()=>{
  fetch('/student/notifications/delete-all-read', { method:'DELETE', headers:{ 'Content-Type':'application/json','X-CSRFToken': csrfToken }})
  .then(r=>r.json()).then(data=>{ if(data.success){ showToast(data.message || 'Cleared read notifications', 'success'); setTimeout(()=>window.location.reload(), 800); } else { showToast('Failed to clear read notifications', 'error'); } })
  .catch(()=>{ showToast('Failed to clear read notifications', 'error'); });
      });
    });}
  });

  function applyFilters(){
    const readFilter = document.getElementById('readFilter').value;
    const typeFilter = document.getElementById('typeFilter').value;
    const params = new URLSearchParams();
    if(readFilter) params.append('read', readFilter);
    if(typeFilter) params.append('type', typeFilter);
    window.location.href = `{{ url_for('student.notifications') }}?${params.toString()}`;
  }
  function clearFilters(){ window.location.href = `{{ url_for('student.notifications') }}`; }

  function showConfirmationModal(message, confirmCallback){
    document.getElementById('confirmationMessage').textContent = message;
    document.getElementById('confirmationModal').classList.remove('hidden');
    const confirmBtn = document.getElementById('confirmActionBtn');
    confirmBtn.onclick = function(){ confirmCallback(); closeConfirmationModal(); };
  }
  function closeConfirmationModal(){ document.getElementById('confirmationModal').classList.add('hidden'); }

  // Minimal toast helper for feedback
  function showToast(message, type = 'info', duration = 3000) {
    const n = document.createElement('div');
    n.className = 'fixed top-20 right-4 z-50 max-w-sm bg-white border-l-4 rounded-lg shadow-lg transform translate-x-full transition-all duration-300 ease-out';
    n.style.minWidth = '260px';
    const colorClass = type==='success' ? 'border-green-500' : type==='error' ? 'border-red-500' : type==='warning' ? 'border-yellow-500' : 'border-blue-500';
    n.classList.add(colorClass);
    const icon = type==='success'?'fa-check-circle':type==='error'?'fa-exclamation-circle':type==='warning'?'fa-exclamation-triangle':'fa-info-circle';
    n.innerHTML = `
      <div class="p-4">
        <div class="flex items-start">
          <div class="flex-shrink-0">
            <i class="fas ${icon}"></i>
          </div>
          <div class="ml-3 w-0 flex-1">
            <p class="text-sm text-gray-900">${message}</p>
          </div>
          <div class="ml-4 flex-shrink-0 flex">
            <button class="bg-white rounded-md inline-flex text-gray-400 hover:text-gray-600" onclick="this.closest('div.fixed').remove()">
              <i class="fas fa-times"></i>
            </button>
          </div>
        </div>
      </div>`;
    document.body.appendChild(n);
    setTimeout(()=>{ n.classList.remove('translate-x-full'); }, 50);
    setTimeout(()=>{ n.classList.add('translate-x-full'); setTimeout(()=>n.remove(), 280); }, duration);
  }
</script>
{% endblock %}
