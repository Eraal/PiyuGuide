{% extends 'office/office_base.html' %}

{% block title %}Feedbacks - {{ super() }}{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto">
  <div class="mb-6">
    <h2 class="text-2xl font-bold text-gray-800">Student Feedbacks</h2>
    <p class="text-sm text-gray-500">Feedback submitted by students after completed counseling sessions.</p>
  </div>

  <!-- Filters -->
  <form method="get" class="bg-white rounded-xl border border-gray-200 shadow-sm p-4 mb-5">
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
      <div>
        <label for="q" class="block text-xs font-semibold text-gray-600 mb-1">Search</label>
        <input type="text" id="q" name="q" value="{{ q }}" placeholder="Student name or message..." class="w-full px-3 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500" />
      </div>
      <div>
        <label for="date_from" class="block text-xs font-semibold text-gray-600 mb-1">From</label>
        <input type="date" id="date_from" name="date_from" value="{{ date_from }}" class="w-full px-3 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500" />
      </div>
      <div>
        <label for="date_to" class="block text-xs font-semibold text-gray-600 mb-1">To</label>
        <input type="date" id="date_to" name="date_to" value="{{ date_to }}" class="w-full px-3 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500" />
      </div>
      <div>
        <label for="sort" class="block text-xs font-semibold text-gray-600 mb-1">Sort</label>
        <select id="sort" name="sort" class="w-full px-3 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500">
          <option value="newest" {% if sort == 'newest' %}selected{% endif %}>Newest first</option>
          <option value="oldest" {% if sort == 'oldest' %}selected{% endif %}>Oldest first</option>
        </select>
      </div>
    </div>
    <div class="mt-4 flex items-center justify-end gap-2">
      <a href="{{ url_for('office.office_feedbacks') }}" class="px-4 py-2 rounded-lg bg-gray-100 text-gray-700 hover:bg-gray-200">Reset</a>
      <button type="submit" class="px-4 py-2 rounded-lg bg-emerald-600 text-white hover:bg-emerald-700">Apply</button>
    </div>
  </form>

  <!-- Table -->
  <div class="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
    <div class="overflow-x-auto">
      <table class="min-w-full whitespace-nowrap">
        <thead class="bg-gray-50">
          <tr class="text-left text-xs font-semibold text-gray-600">
            <th class="px-4 py-3">Submitted</th>
            <th class="px-4 py-3">Student</th>
            <th class="px-4 py-3">Session</th>
            <th class="px-4 py-3">Feedback</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-gray-100">
          {% if feedbacks %}
            {% for f in feedbacks %}
            <tr class="text-sm text-gray-800 align-top">
              <td class="px-4 py-3 text-gray-600">{{ f.created_at.strftime('%b %d, %Y %I:%M %p') if f.created_at else '-' }}</td>
              <td class="px-4 py-3">
                <div class="flex items-center gap-3">
                  {% if f.student_profile_pic_path %}
                  <img src="{{ url_for('static', filename=f.student_profile_pic_path) }}" class="w-8 h-8 rounded-full object-cover" alt="avatar" />
                  {% else %}
                  <div class="w-8 h-8 rounded-full bg-emerald-100 text-emerald-700 flex items-center justify-center font-semibold">{{ f.student_full_name[0] if f.student_full_name else 'S' }}</div>
                  {% endif %}
                  <div>
                    <div class="font-medium">{{ f.student_full_name }}</div>
                  </div>
                </div>
              </td>
              <td class="px-4 py-3 text-gray-700">
                {% if f.session_datetime %}
                  <div>{{ f.session_datetime.strftime('%b %d, %Y %I:%M %p') }}</div>
                  {% if f.session_status %}
                  <div class="text-xs text-gray-500">Status: {{ f.session_status.replace('_',' ').title() }}</div>
                  {% endif %}
                {% else %}-{% endif %}
              </td>
              <td class="px-4 py-3">
                {% set msg = f.message or '' %}
                {% if msg|length <= 160 %}
                  <div class="text-gray-800">{{ msg }}</div>
                {% else %}
                  <div class="text-gray-800"><span class="line-clamp-3 block" id="clip-{{ f.id }}">{{ msg[:160] }}â€¦</span></div>
                  <button type="button" class="mt-2 text-emerald-700 text-xs font-semibold hover:underline" data-target="{{ f.id }}">Read more</button>
                  <div class="hidden mt-2 text-gray-800" id="full-{{ f.id }}">{{ msg }}</div>
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          {% else %}
            <tr>
              <td colspan="4" class="px-4 py-8 text-center text-gray-500">No feedback found.</td>
            </tr>
          {% endif %}
        </tbody>
      </table>
    </div>

    <!-- Pagination -->
    {% if pagination.pages > 1 %}
    <div class="px-4 py-3 bg-gray-50 flex items-center justify-between text-sm text-gray-600">
      <div>Page {{ pagination.page }} of {{ pagination.pages }}</div>
      <div class="space-x-2">
        {% if pagination.has_prev %}
        <a class="px-3 py-1 rounded-md bg-white border border-gray-300 hover:bg-gray-100" href="{{ url_for('office.office_feedbacks', page=pagination.prev_num, q=q, date_from=date_from, date_to=date_to, sort=sort) }}">Previous</a>
        {% else %}
        <span class="px-3 py-1 rounded-md bg-gray-100 border border-gray-200 text-gray-400">Previous</span>
        {% endif %}
        {% if pagination.has_next %}
        <a class="px-3 py-1 rounded-md bg-white border border-gray-300 hover:bg-gray-100" href="{{ url_for('office.office_feedbacks', page=pagination.next_num, q=q, date_from=date_from, date_to=date_to, sort=sort) }}">Next</a>
        {% else %}
        <span class="px-3 py-1 rounded-md bg-gray-100 border border-gray-200 text-gray-400">Next</span>
        {% endif %}
      </div>
    </div>
    {% endif %}
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
  // Expand/collapse long feedback text
  document.addEventListener('click', function(e){
    const btn = e.target.closest('button[data-target]');
    if(!btn) return;
    const id = btn.getAttribute('data-target');
    const clip = document.getElementById('clip-' + id);
    const full = document.getElementById('full-' + id);
    if(clip && full){
      const isHidden = full.classList.contains('hidden');
      if(isHidden){
        full.classList.remove('hidden');
        if(clip) clip.classList.add('hidden');
        btn.textContent = 'Show less';
      } else {
        full.classList.add('hidden');
        if(clip) clip.classList.remove('hidden');
        btn.textContent = 'Read more';
      }
    }
  });
</script>
{% endblock %}
