{% extends 'office/office_base.html' %}
{% block title %}Counseling Details | {{ session.reference_code or ('Session #' ~ session.id) }}{% endblock %}

{% block content %}
<div id="sessionCtx" data-session-id="{{ session.id }}" class="hidden"></div>
<div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
  <div class="flex items-center justify-between mb-4">
    <div>
      <h1 class="text-2xl font-semibold text-gray-800">Counseling Request Details</h1>
      <p class="text-sm text-gray-500">{{ session.reference_code or ('Session #' ~ session.id) }}</p>
    </div>
    <div>
      <span class="inline-flex items-center rounded-md px-2 py-1 text-sm font-medium
        {% if session.status == 'pending' %} bg-yellow-100 text-yellow-800
        {% elif session.status in ['confirmed','in_progress'] %} bg-green-100 text-green-800
        {% elif session.status in ['cancelled','declined'] %} bg-red-100 text-red-800
        {% elif session.status in ['completed'] %} bg-blue-100 text-blue-800
        {% else %} bg-gray-100 text-gray-800 {% endif %}">
        {{ session.status|replace('_', ' ')|title }}
      </span>
    </div>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Left: Details -->
    <div class="lg:col-span-2 space-y-6">
      <section class="bg-white shadow rounded-lg p-5">
        <h2 class="text-lg font-medium text-gray-900 mb-4">Student</h2>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 text-sm">
          <div>
            <div class="text-gray-500">Name</div>
            <div class="text-gray-900">{{ student_user.full_name if student_user else 'N/A' }}</div>
          </div>
          <div>
            <div class="text-gray-500">Email</div>
            <div class="text-gray-900">{{ student_user.email if student_user else 'N/A' }}</div>
          </div>
          <div>
            <div class="text-gray-500">Student No.</div>
            <div class="text-gray-900">{{ student.student_number if student else 'N/A' }}</div>
          </div>
          <div>
            <div class="text-gray-500">Program/Year</div>
            <div class="text-gray-900">{{ student.program if student else 'N/A' }}{% if student and student.year_level %} • Y{{ student.year_level }}{% endif %}</div>
          </div>
        </div>
      </section>

      <section class="bg-white shadow rounded-lg p-5">
        <h2 class="text-lg font-medium text-gray-900 mb-4">Session Info</h2>
        <dl class="grid grid-cols-1 sm:grid-cols-2 gap-4 text-sm">
          <div>
            <dt class="text-gray-500">Type</dt>
            <dd class="text-gray-900">{{ 'Video' if is_video else 'In-person' }}</dd>
          </div>
          <div>
            <dt class="text-gray-500">Preferred Schedule</dt>
            <dd class="text-gray-900">
              {% if session.scheduled_date %}
                {{ session.scheduled_date.strftime('%b %d, %Y') }} {% if session.scheduled_time %}• {{ session.scheduled_time.strftime('%I:%M %p') }}{% endif %}
              {% else %}
                Not yet scheduled
              {% endif %}
            </dd>
          </div>
          <div>
            <dt class="text-gray-500">Concern</dt>
            <dd class="text-gray-900">{{ session.concern_type or 'N/A' }}</dd>
          </div>
          <div>
            <dt class="text-gray-500">Created</dt>
            <dd class="text-gray-900">{{ (session.created_at or session.date_created).strftime('%b %d, %Y %I:%M %p') if (session.created_at or session.date_created) else 'N/A' }}</dd>
          </div>
          <div class="sm:col-span-2">
            <dt class="text-gray-500">Details</dt>
            <dd class="text-gray-900 whitespace-pre-wrap">{{ session.details or session.description or '—' }}</dd>
          </div>
        </dl>
      </section>

      <section class="bg-white shadow rounded-lg p-5">
        <div class="flex items-center justify-between mb-3">
          <h2 class="text-lg font-medium text-gray-900">Counselor Notes</h2>
          <button id="saveNotesBtn" class="px-3 py-1.5 rounded bg-indigo-600 text-white text-sm hover:bg-indigo-700">Save</button>
        </div>
        <textarea id="notesInput" class="w-full h-40 border rounded p-3 focus:outline-none focus:ring" placeholder="Add internal notes visible to office staff only...">{{ session.counselor_notes or '' }}</textarea>
        <p class="text-xs text-gray-500 mt-2">Notes are not visible to students.</p>
      </section>
    </div>

    <!-- Right: Actions -->
    <aside class="space-y-6">
      <section class="bg-white shadow rounded-lg p-5">
        <h2 class="text-lg font-medium text-gray-900 mb-3">Actions</h2>
        <div class="flex flex-col gap-2">
          {% if session.status in ['pending', 'confirmed', 'in_progress'] %}
            <button data-action="assign_confirm" class="action-btn px-3 py-2 rounded bg-blue-600 text-white text-sm hover:bg-blue-700">Assign & Confirm</button>
            <button data-action="reschedule" class="action-btn px-3 py-2 rounded bg-amber-500 text-white text-sm hover:bg-amber-600">Reschedule</button>
            <button data-action="decline" class="action-btn px-3 py-2 rounded bg-red-600 text-white text-sm hover:bg-red-700">Decline</button>
            <button data-action="remind" class="action-btn px-3 py-2 rounded bg-emerald-600 text-white text-sm hover:bg-emerald-700">Remind</button>
          {% endif %}
        </div>
      </section>

      <section class="bg-white shadow rounded-lg p-5">
        <h2 class="text-lg font-medium text-gray-900 mb-3">Quick Info</h2>
        <dl class="text-sm space-y-2">
          <div class="flex justify-between"><dt class="text-gray-500">Mode</dt><dd class="text-gray-900">{{ 'Video' if is_video else 'In-person' }}</dd></div>
          <div class="flex justify-between"><dt class="text-gray-500">Status</dt><dd class="text-gray-900">{{ session.status|replace('_', ' ')|title }}</dd></div>
          {% if is_video %}
          <div class="flex justify-between items-center gap-4">
            <dt class="text-gray-500">Meeting</dt>
            <dd class="text-indigo-700 truncate">
              <a class="underline" href="{{ url_for('office.join_video_session', session_id=session.id) }}" target="_blank" rel="noopener">Open Link</a>
            </dd>
          </div>
          {% endif %}
        </dl>
      </section>
    </aside>
  </div>
</div>

<!-- Reschedule Modal (full-featured to match list page) -->
<div id="detailsRescheduleModal" class="fixed inset-0 z-[90] hidden" aria-modal="true" role="dialog">
  <div class="absolute inset-0 bg-black/50 backdrop-blur-sm" data-details-resch-backdrop></div>
  <div class="relative z-10 max-w-xl w-[95vw] mx-auto my-10 animate-fade-in-up">
    <div class="bg-white rounded-2xl shadow-2xl overflow-hidden">
      <!-- Header -->
      <div class="px-6 py-4 bg-gradient-to-r from-blue-600 to-indigo-600 text-white flex items-center justify-between">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 bg-white/20 rounded-lg flex items-center justify-center"><i class="fas fa-calendar-alt"></i></div>
          <div>
            <h3 class="text-lg font-semibold">Reschedule Session</h3>
            <p class="text-xs text-white/80">Select a new date and time</p>
          </div>
        </div>
        <button type="button" id="detailsReschClose" class="p-2 rounded-lg hover:bg-white/10 transition" aria-label="Close"><i class="fas fa-times"></i></button>
      </div>
      <!-- Body -->
      <div class="p-6 space-y-5">
        <!-- Session summary -->
        <div class="rounded-xl border border-gray-200 bg-gray-50 p-4">
          <div class="flex items-start gap-3">
            <div class="w-9 h-9 rounded-lg bg-gradient-to-br from-blue-500 to-indigo-600 text-white flex items-center justify-center">
              <i class="fas fa-user"></i>
            </div>
            <div class="flex-1 min-w-0">
              <div class="text-sm font-semibold text-gray-900 truncate">{{ student_user.full_name if student_user else 'Student' }}</div>
              <div class="text-xs text-gray-600 mt-1 flex flex-wrap items-center gap-2">
                <span class="inline-flex items-center gap-1"><i class="far fa-calendar text-blue-500"></i><span id="details-resch-current-date">{% if session.scheduled_date %}{{ session.scheduled_date.strftime('%Y-%m-%d') }}{% else %}—{% endif %}</span></span>
                <span class="inline-flex items-center gap-1"><i class="far fa-clock text-green-600"></i><span id="details-resch-current-time">{% if session.scheduled_time %}{{ session.scheduled_time.strftime('%H:%M') }}{% else %}—{% endif %}</span></span>
              </div>
            </div>
          </div>
        </div>

        <!-- Form -->
        <form id="detailsRescheduleForm" class="space-y-4" novalidate>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label for="details_new_date" class="block text-sm font-medium text-gray-700">New Date</label>
              <div class="relative mt-1">
                <input type="date" id="details_new_date" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50 pr-10" required>
                <div class="pointer-events-none absolute inset-y-0 right-3 flex items-center text-gray-400"><i class="far fa-calendar"></i></div>
              </div>
            </div>
            <div>
              <label for="details_new_time" class="block text-sm font-medium text-gray-700">New Time</label>
              <div class="relative mt-1">
                <input type="time" id="details_new_time" step="3600" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50 pr-10" required>
                <div class="pointer-events-none absolute inset-y-0 right-3 flex items-center text-gray-400"><i class="far fa-clock"></i></div>
              </div>
            </div>
          </div>

          <!-- Quick picks -->
          <div class="flex flex-wrap items-center gap-2">
            <span class="text-xs text-gray-500 mr-1">Quick picks:</span>
            <button type="button" class="px-3 py-1.5 rounded-full text-xs bg-gray-100 hover:bg-gray-200 text-gray-700" data-details-resch-quick="+60">+1 hour</button>
            <button type="button" class="px-3 py-1.5 rounded-full text-xs bg-gray-100 hover:bg-gray-200 text-gray-700" data-details-resch-quick="tomorrow">Tomorrow same time</button>
            <button type="button" class="px-3 py-1.5 rounded-full text-xs bg-gray-100 hover:bg-gray-200 text-gray-700" data-details-resch-quick="nextweek">Next week</button>
          </div>

          <!-- Working hours hint -->
          <div id="details-resch-hours-hint" class="text-xs text-gray-500"></div>

          <!-- Time-slot picker -->
          <div id="detailsSlotPickerWrap" class="hidden space-y-2">
            <div class="text-sm font-medium text-gray-700 flex items-center gap-2">
              <i class="far fa-clock text-blue-500"></i>
              <span>Available time slots</span>
            </div>
            <div id="detailsSlotPicker" class="grid grid-cols-3 sm:grid-cols-4 gap-2"></div>
            <div id="detailsSlotHint" class="text-xs text-gray-500"></div>
          </div>

          <div id="details-resch-error" class="hidden text-sm text-red-600 bg-red-50 border border-red-200 rounded-md px-3 py-2"></div>

          <div class="text-sm text-blue-700 bg-blue-50 border border-blue-200 rounded-md px-3 py-2">
            <i class="fas fa-info-circle mr-1"></i>
            The student will be notified of this schedule change.
          </div>
        </form>
      </div>
      <!-- Footer -->
      <div class="px-6 py-4 bg-gray-50 flex justify-end gap-2">
        <button type="button" id="detailsReschCancel" class="inline-flex justify-center rounded-lg border border-gray-300 px-4 py-2 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50">Cancel</button>
        <button type="button" id="detailsReschConfirm" class="inline-flex justify-center rounded-lg px-4 py-2 bg-blue-600 text-sm font-medium text-white hover:bg-blue-700 shadow-sm">Confirm Reschedule</button>
      </div>
    </div>
  </div>
  <!-- /Panel -->
 </div>

<!-- Reschedule Confirmation Modal (details) -->
<div id="detailsRescheduleConfirmModal" class="fixed inset-0 z-[100] hidden">
  <div class="absolute inset-0 bg-black/50 backdrop-blur-sm"></div>
  <div class="relative z-10 max-w-md w-[95vw] mx-auto my-10">
    <div class="bg-white rounded-2xl shadow-2xl overflow-hidden">
      <div class="px-6 py-4 bg-gradient-to-r from-emerald-600 to-green-600 text-white flex items-center justify-between">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 bg-white/20 rounded-lg flex items-center justify-center"><i class="fas fa-check-circle"></i></div>
          <h3 class="text-lg font-semibold">Session Rescheduled</h3>
        </div>
        <button type="button" id="detailsReschConfirmClose" class="p-2 rounded-lg hover:bg-white/10 transition" aria-label="Close"><i class="fas fa-times"></i></button>
      </div>
      <div class="p-6 space-y-3">
        <p class="text-gray-700">The session has been rescheduled to:</p>
        <p id="detailsReschConfirmWhen" class="text-base font-semibold text-gray-900">—</p>
        <p class="text-sm text-gray-500">A notification has been sent to the student.</p>
      </div>
      <div class="px-6 py-4 bg-gray-50 flex justify-end">
        <button type="button" id="detailsReschConfirmOk" class="inline-flex justify-center rounded-lg px-4 py-2 bg-emerald-600 text-sm font-medium text-white hover:bg-emerald-700 shadow-sm">OK</button>
      </div>
    </div>
  </div>
  <!-- /Panel -->
 </div>

<script>
  const sessionId = Number(document.getElementById('sessionCtx')?.dataset.sessionId || '0');
  function getCsrfToken(){ try { return document.querySelector('meta[name="csrf-token"]').getAttribute('content'); } catch(_) { return ''; } }

  // Helpers copied from list page for consistency
  const WORKING_HOURS = { start: '08:00', end: '17:00' };
  const SLOT_STEP_MINUTES = 60;
  const DISABLE_WEEKENDS = true;
  const HOLIDAYS = [];
  function isWeekend(date) { const d = (date instanceof Date) ? date : new Date(date); const day = d.getDay(); return day===0 || day===6; }
  function timeToMinutes(t){ const [h,m] = t.split(':').map(Number); return h*60+(m||0); }
  function formatTime12(t24){ if(!t24||!/^[0-2]\d:[0-5]\d$/.test(t24)) return t24||''; let [hh,mm] = t24.split(':').map(Number); const ap = hh>=12?'PM':'AM'; hh = hh%12||12; return `${hh}:${String(mm).padStart(2,'0')} ${ap}`; }
  function formatDateInput(d){ try{ const dt=(d instanceof Date)?d:new Date(d); const y=dt.getFullYear(); const m=String(dt.getMonth()+1).padStart(2,'0'); const da=String(dt.getDate()).padStart(2,'0'); return `${y}-${m}-${da}`; }catch(_){ return ''; } }
  function roundToStep(dateObj, stepMins){ const ms=(stepMins||60)*60000; const t=dateObj instanceof Date?dateObj.getTime():new Date(dateObj).getTime(); return new Date(Math.ceil(t/ms)*ms); }
  function clampToWorkingHours(dateObj){ const minutes=dateObj.getHours()*60+dateObj.getMinutes(); const startM=timeToMinutes(WORKING_HOURS.start); const endM=timeToMinutes(WORKING_HOURS.end); let c=new Date(dateObj); if (minutes<startM){ c.setHours(Math.floor(startM/60), startM%60,0,0);} if (minutes>endM){ c.setHours(Math.floor(endM/60), endM%60,0,0);} return c; }
  function getNextBusinessDay(dateObj){ const d=new Date(dateObj); do{ d.setDate(d.getDate()+1);} while ((DISABLE_WEEKENDS && isWeekend(d)) || HOLIDAYS.includes(formatDateInput(d))); return d; }
  function getSlotsForDate(dateStr){ const slots=[]; const date=new Date(dateStr+'T00:00:00'); if ((DISABLE_WEEKENDS && isWeekend(date))){ return slots; } const startM=timeToMinutes(WORKING_HOURS.start); const endM=timeToMinutes(WORKING_HOURS.end); const now=new Date(); const isToday=formatDateInput(now)===dateStr; let minM=startM; if (isToday){ const minFuture=roundToStep(new Date(now.getTime()+60*60000),60); minM=Math.max(minM, minFuture.getHours()*60+minFuture.getMinutes()); } const latestStart=endM-SLOT_STEP_MINUTES; for(let m=minM; m<=latestStart; m+=SLOT_STEP_MINUTES){ slots.push(`${String(Math.floor(m/60)).padStart(2,'0')}:${String(m%60).padStart(2,'0')}`);} return slots; }

  async function postJSON(url, payload) {
    const res = await fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCsrfToken() },
      body: JSON.stringify(payload || {})
    });
    if (!res.ok) throw new Error('Request failed');
    return res.json().catch(() => ({}));
  }

  async function postForm(url, dataObj) {
    const body = new URLSearchParams();
    Object.entries(dataObj || {}).forEach(([k,v]) => body.append(k, v));
    const res = await fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded', 'X-CSRFToken': getCsrfToken() },
      body: body.toString()
    });
    if (!res.ok) throw new Error('Request failed');
    return res.json().catch(() => ({}));
  }

  document.getElementById('saveNotesBtn')?.addEventListener('click', async () => {
    const notes = document.getElementById('notesInput').value;
    try {
      await postJSON(`{{ url_for('office.update_session_notes', session_id=0) }}`.replace('0', sessionId), { notes });
      window.dispatchEvent(new CustomEvent('showToast', { detail: { type: 'success', message: 'Notes saved' }}));
    } catch (e) {
      window.dispatchEvent(new CustomEvent('showToast', { detail: { type: 'error', message: 'Failed to save notes' }}));
    }
  });

  // Details page actions
  document.querySelectorAll('.action-btn').forEach(btn => {
    btn.addEventListener('click', async () => {
      const action = btn.getAttribute('data-action');
      try {
        if (action === 'assign_confirm') {
          // Assign to current admin then confirm
          const assignResp = await postForm(`{{ url_for('office.assign_counseling_session', session_id=0) }}`.replace('0', sessionId), {});
          // Proceed to confirm only if assign didn't error with conflict
          await postForm(`{{ url_for('office.update_session_status', session_id=0) }}`.replace('0', sessionId), { status: 'confirmed' });
          window.location.reload();
          return;
        } else if (action === 'reschedule') {
          // Open local reschedule modal
          const m = document.getElementById('detailsRescheduleModal');
          // Prefill with today rounded +1h
          const now = new Date();
          const rounded = new Date(Math.ceil((now.getTime()+3600000) / 3600000) * 3600000);
          const yyyy = rounded.getFullYear();
          const mm = String(rounded.getMonth()+1).padStart(2,'0');
          const dd = String(rounded.getDate()).padStart(2,'0');
          const HH = String(rounded.getHours()).padStart(2,'0');
          const MM = '00';
          const dEl = document.getElementById('details_new_date');
          const tEl = document.getElementById('details_new_time');
          if (dEl && !dEl.value) dEl.value = `${yyyy}-${mm}-${dd}`;
          if (tEl && !tEl.value) tEl.value = `${HH}:${MM}`;
          m && m.classList.remove('hidden');
          return;
        } else if (action === 'decline') {
          await postForm(`{{ url_for('office.update_session_status', session_id=0) }}`.replace('0', sessionId), { status: 'declined' });
        } else if (action === 'remind') {
          await postForm(`{{ url_for('office.send_session_reminder', session_id=0) }}`.replace('0', sessionId), { type: 'in_app' });
        }
        window.location.reload();
      } catch (e) {
        window.dispatchEvent(new CustomEvent('showToast', { detail: { type: 'error', message: 'Action failed' }}));
      }
    });
  });

  // Details reschedule modal handlers and slot picker
  const drModal = document.getElementById('detailsRescheduleModal');
  const drClose = document.getElementById('detailsReschClose');
  const drCancel = document.getElementById('detailsReschCancel');
  const drConfirm = document.getElementById('detailsReschConfirm');
  const drError = document.getElementById('details-resch-error');
  const dDateEl = document.getElementById('details_new_date');
  const dTimeEl = document.getElementById('details_new_time');
  const dSlotsWrap = document.getElementById('detailsSlotPickerWrap');
  const dSlotsGrid = document.getElementById('detailsSlotPicker');
  const dSlotHint = document.getElementById('detailsSlotHint');
  const dHoursHint = document.getElementById('details-resch-hours-hint');

  function hideDetailsResch(){ drModal && drModal.classList.add('hidden'); if (drError){ drError.classList.add('hidden'); drError.textContent=''; } }
  drClose && drClose.addEventListener('click', hideDetailsResch);
  drCancel && drCancel.addEventListener('click', hideDetailsResch);
  drModal && drModal.addEventListener('click', (e)=>{ if (e.target && e.target.hasAttribute('data-details-resch-backdrop')) hideDetailsResch(); });

  function updateDetailsWorkingHoursHint(){ if (!dHoursHint) return; const dateStr=dDateEl?.value||''; const weekend = dateStr && isWeekend(new Date(dateStr)); let text=`Working hours: ${formatTime12(WORKING_HOURS.start)} - ${formatTime12(WORKING_HOURS.end)}`; if (dateStr){ if (DISABLE_WEEKENDS && weekend){ text += ' • Selected date is a weekend'; } if (HOLIDAYS.includes(dateStr)){ text += ' • Holiday'; } } dHoursHint.textContent = text; dHoursHint.className = 'text-xs ' + ((DISABLE_WEEKENDS && weekend)?'text-red-600':'text-gray-500'); }

  async function updateDetailsSlotPicker(){
    if (!dSlotsWrap || !dSlotsGrid || !dDateEl) return;
    const dateStr = dDateEl.value || '';
    dSlotsGrid.innerHTML = '';
    if (!dateStr){ dSlotsWrap.classList.add('hidden'); return; }
    updateDetailsWorkingHoursHint();
    let slots = [];
    try {
      const resp = await fetch(`/office/video-session/availability?date=${encodeURIComponent(dateStr)}&exclude_session_id=${sessionId}`);
      if (resp.ok){ const data = await resp.json(); slots = data.slots || []; }
    } catch(_){ }
    if (!slots.length) { slots = (getSlotsForDate(dateStr)||[]).map(t=>({time:t,status:'available'})); }
    if (!slots.length){ dSlotsWrap.classList.remove('hidden'); dSlotHint.textContent = 'No slots available for this date.'; return; }
    dSlotHint.textContent = 'Click a 1-hour slot to fill the time field.';
    dSlotsWrap.classList.remove('hidden');
    const currentVal = dTimeEl?.value;
    slots.forEach(s => {
      const t = s.time; const status = s.status || 'available';
      const btn = document.createElement('button'); btn.type = 'button';
      const isSelected = (t === currentVal); const isDisabled = status !== 'available';
      btn.className = 'px-3 py-2 rounded-lg text-xs border transition-all duration-200 ' + (
        isSelected ? 'bg-blue-600 text-white border-blue-600 ring-2 ring-blue-300' :
        isDisabled ? 'bg-gray-100 text-gray-400 border-gray-200 cursor-not-allowed' :
        'bg-white text-gray-700 border-gray-200 hover:bg-gray-100 hover:scale-105'
      );
      btn.textContent = `${formatTime12(t)} - ${formatTime12(String(parseInt(t.split(':')[0])+1).padStart(2,'0')+':'+t.split(':')[1])}`;
      if (!isDisabled){
        btn.addEventListener('click', ()=>{
          if (dTimeEl) dTimeEl.value = t;
          Array.from(dSlotsGrid.querySelectorAll('button')).forEach(b=>{
            b.classList.remove('bg-blue-600','text-white','border-blue-600','ring-2','ring-blue-300');
            b.classList.add('bg-white','text-gray-700','border-gray-200');
          });
          btn.classList.remove('bg-white','text-gray-700','border-gray-200');
          btn.classList.add('bg-blue-600','text-white','border-blue-600','ring-2','ring-blue-300');
          btn.style.transform='scale(0.98)'; setTimeout(()=>{ btn.style.transform='scale(1)'; }, 100);
        });
      } else { btn.disabled = true; }
      dSlotsGrid.appendChild(btn);
    });
  }

  // Quick picks
  document.querySelectorAll('[data-details-resch-quick]').forEach(el => {
    el.addEventListener('click', ()=>{
      let base = new Date();
      if (dDateEl?.value && dTimeEl?.value){ base = new Date(`${dDateEl.value}T${dTimeEl.value}`); }
      const val = el.getAttribute('data-details-resch-quick');
      let next = new Date(base);
      if (val === '+60') next = roundToStep(new Date(base.getTime()+60*60000), 60);
      else if (val === 'tomorrow') next.setDate(next.getDate()+1);
      else if (val === 'nextweek') next.setDate(next.getDate()+7);
      if (DISABLE_WEEKENDS && isWeekend(next)) next = getNextBusinessDay(next);
      next = clampToWorkingHours(next);
      if (dDateEl) dDateEl.value = formatDateInput(next);
      if (dTimeEl) dTimeEl.value = `${String(next.getHours()).padStart(2,'0')}:${String(next.getMinutes()).padStart(2,'0')}`;
      updateDetailsSlotPicker();
    });
  });

  dDateEl?.addEventListener('change', updateDetailsSlotPicker);
  dTimeEl?.addEventListener('input', updateDetailsSlotPicker);

  drConfirm && drConfirm.addEventListener('click', async ()=>{
    const d = dDateEl?.value; const t = dTimeEl?.value;
    if (!d || !t){ drError && (drError.textContent = 'Please select both date and time.', drError.classList.remove('hidden')); return; }
    const selectedDateTime = new Date(d + 'T' + t);
    if (selectedDateTime <= new Date()){
      drError && (drError.textContent = 'Please select a future date and time.', drError.classList.remove('hidden'));
      return;
    }
    // Loading state
    const orig = drConfirm.textContent; drConfirm.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Rescheduling...'; drConfirm.disabled = true;
    try {
      const resp = await fetch(`{{ url_for('office.reschedule_session', session_id=0) }}`.replace('0', sessionId), {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded', 'X-CSRFToken': getCsrfToken() },
        body: `reschedule_date=${encodeURIComponent(d)}&reschedule_time=${encodeURIComponent(t)}`
      });
      const data = await resp.json();
      if (resp.ok && data.status === 'success'){
        // Show confirmation modal
        drModal.classList.add('hidden');
        const cm = document.getElementById('detailsRescheduleConfirmModal');
        const cw = document.getElementById('detailsReschConfirmWhen');
        let whenRaw = (data.new_time || `${d} ${t}`);
        let label = whenRaw.replace('T',' ');
        const m = label.match(/(\d{4}-\d{2}-\d{2})[ T](\d{2}:\d{2})/);
        if (m){ label = `${m[1]} ${formatTime12(m[2])}`; }
        if (cw) cw.textContent = label;
        cm && cm.classList.remove('hidden');
      } else {
        drError && (drError.textContent = data.message || 'Failed to reschedule. Please try another time.', drError.classList.remove('hidden'));
      }
    } catch (err){
      drError && (drError.textContent = 'An unexpected error occurred.', drError.classList.remove('hidden'));
    } finally { drConfirm.textContent = orig; drConfirm.disabled = false; }
  });

  // Confirmation modal controls
  const dReschConfirm = document.getElementById('detailsRescheduleConfirmModal');
  function closeDetailsReschConfirm(){ dReschConfirm?.classList.add('hidden'); window.location.reload(); }
  document.getElementById('detailsReschConfirmOk')?.addEventListener('click', closeDetailsReschConfirm);
  document.getElementById('detailsReschConfirmClose')?.addEventListener('click', closeDetailsReschConfirm);
</script>
{% endblock %}
