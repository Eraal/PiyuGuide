{% extends "admin/adminbase.html" %}

{% block title %}Edit Admin - {{ current_campus_name }} Campus Admin{% endblock %}

{% block content %}
<div class="space-y-6 animate-[fadeIn_.4s_ease-out]">
    <!-- Back Button -->
    <div>
        <a href="{{ url_for('admin.view_admin_details', admin_id=admin.id) }}"
             class="inline-flex items-center px-4 py-2 rounded-xl border border-gray-200 bg-white text-gray-700 hover:text-blue-700 hover:border-blue-200 shadow-sm hover:shadow transition-all duration-300 group">
            <i class="fas fa-arrow-left mr-2 transition-transform duration-300 group-hover:-translate-x-1"></i>
            Back to Admin Details
        </a>
    </div>

    {% if admin %}
    <!-- Hero Header -->
    <div class="relative rounded-3xl overflow-hidden bg-gradient-to-br from-blue-900 via-indigo-900 to-sky-900 text-white shadow-2xl">
        <div class="absolute inset-0 opacity-10 pointer-events-none">
            <div class="absolute -top-10 -left-10 w-48 h-48 rounded-full border-2 border-white/30"></div>
            <div class="absolute bottom-0 right-10 w-24 h-24 rounded-full border-2 border-white/20"></div>
        </div>
        <div class="relative p-6 lg:p-8">
            <div class="flex items-start gap-4">
                <div class="w-20 h-20 lg:w-24 lg:h-24 rounded-2xl overflow-hidden bg-white/10 border-2 border-white/20 flex items-center justify-center shadow-lg ring-1 ring-white/20">
                    {% if admin.user.profile_pic %}
                    <img src="{{ url_for('static', filename=admin.user.profile_pic) }}" alt="Profile" class="w-full h-full object-cover" />
                    {% else %}
                    <span class="text-3xl font-bold">{{ admin.user.first_name[0] }}{{ admin.user.last_name[0] }}</span>
                    {% endif %}
                </div>
                <div class="flex-1">
                    <h1 class="text-2xl lg:text-3xl font-bold tracking-tight">Edit Office Admin</h1>
                    <div class="mt-1 text-blue-100 flex flex-wrap items-center gap-3">
                        <span class="text-sm"><i class="fas fa-user mr-1"></i>{{ admin.user.get_full_name() }}</span>
                        <span class="text-blue-200">•</span>
                        <span class="text-sm"><i class="fas fa-envelope mr-1"></i>{{ admin.user.email }}</span>
                        <span class="text-blue-200">•</span>
                        <span class="text-sm"><i class="fas fa-briefcase mr-1"></i>{{ admin.office.name }}</span>
                        <span class="px-2.5 py-1 rounded-full text-xs font-semibold border {% if admin.user.is_active %}bg-emerald-50 text-emerald-700 border-emerald-200{% else %}bg-rose-50 text-rose-700 border-rose-200{% endif %}">
                            {{ 'Active' if admin.user.is_active else 'Inactive' }}
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <form method="POST" action="{{ url_for('admin.edit_office_admin', admin_id=admin.id) }}" enctype="multipart/form-data">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
            <!-- Sidebar Profile Card -->
            <aside class="col-span-1">
                <div class="bg-white rounded-2xl border border-gray-100 shadow-sm p-6 sticky top-24 animate-[riseIn_.5s_ease-out]">
                    <div class="flex flex-col items-center text-center">
                        <div class="relative group">
                            <div class="h-32 w-32 rounded-full bg-blue-50 flex items-center justify-center overflow-hidden mb-4 ring-4 ring-white shadow-sm border border-gray-100 transition-all duration-300">
                                {% if admin.user.profile_pic %}
                                <img src="{{ url_for('static', filename=admin.user.profile_pic) }}" alt="Profile" class="h-full w-full object-cover" id="profile-preview">
                                {% else %}
                                <div class="text-4xl font-bold text-blue-600" id="initials">{{ admin.user.first_name[0] }}{{ admin.user.last_name[0] }}</div>
                                <img src="" alt="Profile" class="h-full w-full object-cover hidden" id="profile-preview">
                                {% endif %}
                            </div>
                            <label for="profile_pic" class="absolute inset-0 flex items-center justify-center bg-black/40 rounded-full opacity-0 group-hover:opacity-100 cursor-pointer transition-all duration-300 ease-in-out">
                                <i class="fas fa-camera text-white text-xl"></i>
                            </label>
                            <input type="file" id="profile_pic" name="profile_pic" class="hidden">
                        </div>
                        <div class="mt-2 text-sm text-gray-500">Click to change profile photo</div>
                    </div>
                    <div class="mt-6 space-y-2">
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-500">Role</span>
                            <span class="font-medium text-gray-900">Office Admin</span>
                        </div>
                        <div class="flex justify-between text-sm border-t border-gray-100 pt-3">
                            <span class="text-gray-500">Joined</span>
                            <span class="font-medium text-gray-900">{{ admin.user.created_at.strftime('%b %d, %Y') }}</span>
                        </div>
                    </div>
                </div>
            </aside>

            <!-- Main Form -->
            <section class="col-span-1 lg:col-span-3 space-y-6">
                <!-- Personal Information -->
                <div class="bg-white rounded-2xl border border-gray-100 shadow-sm">
                    <div class="px-6 py-4 flex items-center gap-2">
                        <i class="fas fa-id-card text-blue-600"></i>
                        <h3 class="text-lg font-semibold text-gray-900">Personal Information</h3>
                    </div>
                    <div class="border-t border-gray-100"></div>
                    <div class="p-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="first_name" class="block text-sm font-medium text-gray-700 mb-2">First Name <span class="text-red-500">*</span></label>
                                <input type="text" id="first_name" name="first_name" value="{{ admin.user.first_name }}" required
                                             class="block w-full rounded-xl border-gray-300 shadow-sm focus:border-blue-600 focus:ring-blue-600 sm:text-sm py-2.5 px-4 transition-colors duration-200">
                            </div>
                            <div>
                                <label for="last_name" class="block text-sm font-medium text-gray-700 mb-2">Last Name <span class="text-red-500">*</span></label>
                                <input type="text" id="last_name" name="last_name" value="{{ admin.user.last_name }}" required
                                             class="block w-full rounded-xl border-gray-300 shadow-sm focus:border-blue-600 focus:ring-blue-600 sm:text-sm py-2.5 px-4 transition-colors duration-200">
                            </div>
                            <div>
                                <label for="middle_name" class="block text-sm font-medium text-gray-700 mb-2">Middle Name</label>
                                <input type="text" id="middle_name" name="middle_name" value="{{ admin.user.middle_name or '' }}"
                                             class="block w-full rounded-xl border-gray-300 shadow-sm focus:border-blue-600 focus:ring-blue-600 sm:text-sm py-2.5 px-4 transition-colors duration-200">
                            </div>
                            <div>
                                <label for="email" class="block text-sm font-medium text-gray-700 mb-2">Email Address <span class="text-red-500">*</span></label>
                                <input type="email" id="email" name="email" value="{{ admin.user.email }}" required
                                             class="block w-full rounded-xl border-gray-300 shadow-sm focus:border-blue-600 focus:ring-blue-600 sm:text-sm py-2.5 px-4 transition-colors duration-200">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Office Assignment -->
                <div class="bg-white rounded-2xl border border-gray-100 shadow-sm">
                    <div class="px-6 py-4 flex items-center gap-2">
                        <i class="fas fa-building text-blue-600"></i>
                        <h3 class="text-lg font-semibold text-gray-900">Office Assignment</h3>
                    </div>
                    <div class="border-t border-gray-100"></div>
                    <div class="p-6">
                        <div>
                            <label for="office_id" class="block text-sm font-medium text-gray-700 mb-2">Assigned Office <span class="text-red-500">*</span></label>
                            <select id="office_id" name="office_id" required
                                            class="block w-full rounded-xl border-gray-300 shadow-sm focus:border-blue-600 focus:ring-blue-600 sm:text-sm py-2.5 px-4 transition-colors duration-200 appearance-none bg-white">
                                {% for office in offices %}
                                <option value="{{ office.id }}" {% if office.id == admin.office_id %}selected{% endif %}>{{ office.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Account Settings -->
                <div class="bg-white rounded-2xl border border-gray-100 shadow-sm">
                    <div class="px-6 py-4 flex items-center gap-2">
                        <i class="fas fa-user-cog text-blue-600"></i>
                        <h3 class="text-lg font-semibold text-gray-900">Account Settings</h3>
                    </div>
                    <div class="border-t border-gray-100"></div>
                    <div class="p-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="password" class="block text-sm font-medium text-gray-700 mb-2">New Password</label>
                                <div class="mt-1 relative rounded-md">
                                    <input type="password" id="password" name="password" placeholder="Leave blank to keep current password"
                                                 class="block w-full rounded-xl border-gray-300 shadow-sm focus:border-blue-600 focus:ring-blue-600 sm:text-sm py-2.5 px-4 transition-colors duration-200">
                                    <p class="mt-2 text-xs text-gray-500">Leave blank if you don't want to change the password.</p>
                                </div>
                            </div>
                            <div>
                                <label for="password_confirm" class="block text-sm font-medium text-gray-700 mb-2">Confirm New Password</label>
                                <div class="mt-1 relative rounded-md">
                                    <input type="password" id="password_confirm" name="password_confirm" placeholder="Leave blank to keep current password"
                                                 class="block w-full rounded-xl border-gray-300 shadow-sm focus:border-blue-600 focus:ring-blue-600 sm:text-sm py-2.5 px-4 transition-colors duration-200">
                                </div>
                            </div>
                        </div>

                        <div class="mt-8 grid grid-cols-1 md:grid-cols-2 gap-6">
                            <label class="flex items-start cursor-pointer">
                                <input type="checkbox" id="is_active" name="is_active" {% if admin.user.is_active %}checked{% endif %}
                                             class="h-5 w-5 rounded border-gray-300 text-blue-600 focus:ring-blue-600 transition-colors duration-200 mt-0.5">
                                <span class="ml-3 text-sm">
                                    <span class="font-medium text-gray-700">Active Account</span>
                                    <p class="text-gray-500 mt-1">Allow this admin to log in to the system</p>
                                </span>
                            </label>

                            <label class="flex items-start cursor-pointer">
                                <input type="checkbox" id="reset_password" name="reset_password"
                                             class="h-5 w-5 rounded border-gray-300 text-blue-600 focus:ring-blue-600 transition-colors duration-200 mt-0.5">
                                <span class="ml-3 text-sm">
                                    <span class="font-medium text-gray-700">Require Password Reset</span>
                                    <p class="text-gray-500 mt-1">Force password change on next login</p>
                                </span>
                            </label>

                            {% if admin.user.account_locked %}
                            <label class="flex items-start cursor-pointer md:col-span-2">
                                <input type="checkbox" id="unlock_account" name="unlock_account"
                                             class="h-5 w-5 rounded border-gray-300 text-blue-600 focus:ring-blue-600 transition-colors duration-200 mt-0.5">
                                <span class="ml-3 text-sm">
                                    <span class="font-medium text-gray-700">Unlock Account</span>
                                    <p class="text-gray-500 mt-1">Re-enable login after lockout</p>
                                </span>
                            </label>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <div class="flex justify-end gap-3 pt-2">
                    <a href="{{ url_for('admin.view_admin_details', admin_id=admin.id) }}"
                         class="inline-flex justify-center items-center py-2.5 px-5 border border-gray-300 shadow-sm text-sm font-medium rounded-xl text-gray-700 bg-white hover:bg-gray-50 transition-all">
                        Cancel
                    </a>
                    <button type="submit"
                                    class="inline-flex justify-center items-center py-2.5 px-5 border border-transparent shadow-sm text-sm font-medium rounded-xl text-white bg-blue-600 hover:bg-blue-700 transition-colors">
                        Save Changes
                    </button>
                </div>
            </section>
        </div>
    </form>
    {% else %}
    <div class="text-center py-16 bg-white rounded-2xl border border-gray-100 shadow-sm">
        <div class="text-gray-400 mb-3"><i class="fas fa-user-slash fa-3x"></i></div>
        <h2 class="text-xl font-semibold text-gray-800 mb-1">Admin Not Found</h2>
        <p class="text-gray-500">The requested administrator could not be found in the system.</p>
        <div class="mt-6">
            <a href="{{ url_for('admin.office_statistics') }}" class="inline-flex items-center px-5 py-2.5 text-sm font-medium rounded-xl text-white bg-blue-600 hover:bg-blue-700 shadow">
                Return to Office Statistics
            </a>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<style>
    @keyframes fadeIn { from { opacity: 0; transform: translateY(6px);} to { opacity: 1; transform: translateY(0);} }
    @keyframes riseIn { from { opacity: 0; transform: translateY(10px);} to { opacity: 1; transform: translateY(0);} }
</style>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Handle profile picture preview
        const profileInput = document.getElementById('profile_pic');
        const profilePreview = document.getElementById('profile-preview');
        const initials = document.getElementById('initials');
        
        if (profileInput) {
            profileInput.addEventListener('change', function() {
                if (this.files && this.files[0]) {
                    const reader = new FileReader();
                    
                    reader.onload = function(e) {
                        profilePreview.src = e.target.result;
                        profilePreview.classList.remove('hidden');
                        if (initials) {
                            initials.classList.add('hidden');
                        }
                    }
                    
                    reader.readAsDataURL(this.files[0]);
                }
            });
        }
        
        // Password validation
        const passwordInput = document.getElementById('password');
        const confirmPasswordInput = document.getElementById('password_confirm');
    const form = document.querySelector('form');
        
        form.addEventListener('submit', function(event) {
            if (passwordInput.value && passwordInput.value !== confirmPasswordInput.value) {
                event.preventDefault();
                
                // Create a more elegant error notification
                const errorDiv = document.createElement('div');
                errorDiv.className = 'fixed top-4 right-4 bg-red-50 border-l-4 border-red-500 text-red-700 p-4 rounded-lg shadow-md z-50';
                errorDiv.innerHTML = `
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <svg class="h-5 w-5 text-red-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                            </svg>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm font-medium">Passwords do not match!</p>
                        </div>
                    </div>`;
                
                document.body.appendChild(errorDiv);
                
                // Focus on the confirm password field
                confirmPasswordInput.focus();
                
                // Remove the notification after 3 seconds
                setTimeout(() => {
                    errorDiv.style.opacity = '0';
                    errorDiv.style.transition = 'opacity 0.5s ease';
                    
                    setTimeout(() => {
                        document.body.removeChild(errorDiv);
                    }, 500);
                }, 3000);
            }
        });
        
        // Flash message fade out
    const flashMessage = document.getElementById('flashMessage');
        if (flashMessage) {
            setTimeout(function() {
                flashMessage.style.opacity = '0';
                flashMessage.style.transition = 'opacity 0.5s ease';
                
                setTimeout(function() {
                    flashMessage.style.display = 'none';
                }, 500);
            }, 5000);
        }
    });
</script>
{% endblock %}