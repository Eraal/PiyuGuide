{% extends "admin/adminbase.html" %}

{% block title %}Counseling Sessions | KapiyuGuide Admin{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Page Header -->
    <div class="flex justify-between items-center bg-white p-4 rounded-lg shadow">
        <h1 class="text-2xl font-bold text-gray-800">Counseling Sessions Management</h1>
        <div class="flex space-x-2">
            <button id="exportCSV" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md flex items-center">
                <i class="fas fa-file-csv mr-2"></i> Export CSV
            </button>
            <button id="printReport" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md flex items-center">
                <i class="fas fa-print mr-2"></i> Print Report
            </button>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        <!-- Total Sessions Card -->
        <div class="bg-white p-4 rounded-lg shadow hover:shadow-md transition-shadow">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-500">Total Sessions</p>
                    <h3 class="text-2xl font-bold text-gray-800" id="totalSessions">{{ total_sessions }}</h3>
                </div>
                <div class="p-3 bg-blue-100 rounded-full">
                    <i class="fas fa-calendar-check text-blue-600 text-xl"></i>
                </div>
            </div>
            <div class="mt-4 text-sm text-gray-500">
                <span class="flex items-center">
                    <span id="sessionTrend" class="font-medium {% if session_trend >= 0 %}text-green-600{% else %}text-red-600{% endif %} mr-1">
                        {% if session_trend >= 0 %}+{% endif %}{{ session_trend }}%
                    </span> from previous month
                </span>
            </div>
        </div>

        <!-- Pending Sessions Card -->
        <div class="bg-white p-4 rounded-lg shadow hover:shadow-md transition-shadow">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-500">Pending Sessions</p>
                    <h3 class="text-2xl font-bold text-yellow-600" id="pendingSessions">{{ pending_sessions }}</h3>
                </div>
                <div class="p-3 bg-yellow-100 rounded-full">
                    <i class="fas fa-clock text-yellow-600 text-xl"></i>
                </div>
            </div>
            <div class="mt-4 text-sm text-gray-500">
                <span class="flex items-center">
                    <span id="pendingTrend" class="font-medium text-yellow-600 mr-1">{{ pending_sessions_percent }}%</span> of all sessions
                </span>
            </div>
        </div>

        <!-- Completed Sessions Card -->
        <div class="bg-white p-4 rounded-lg shadow hover:shadow-md transition-shadow">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-500">Completed Sessions</p>
                    <h3 class="text-2xl font-bold text-green-600" id="completedSessions">{{ completed_sessions }}</h3>
                </div>
                <div class="p-3 bg-green-100 rounded-full">
                    <i class="fas fa-check-circle text-green-600 text-xl"></i>
                </div>
            </div>
            <div class="mt-4 text-sm text-gray-500">
                <span class="flex items-center">
                    <span id="completedTrend" class="font-medium text-green-600 mr-1">{{ completed_sessions_percent }}%</span> of all sessions
                </span>
            </div>
        </div>

        <!-- Cancelled Sessions Card -->
        <div class="bg-white p-4 rounded-lg shadow hover:shadow-md transition-shadow">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-500">Cancelled Sessions</p>
                    <h3 class="text-2xl font-bold text-red-600" id="cancelledSessions">{{ cancelled_sessions }}</h3>
                </div>
                <div class="p-3 bg-red-100 rounded-full">
                    <i class="fas fa-times-circle text-red-600 text-xl"></i>
                </div>
            </div>
            <div class="mt-4 text-sm text-gray-500">
                <span class="flex items-center">
                    <span id="cancelledTrend" class="font-medium text-red-600 mr-1">{{ cancelled_sessions_percent }}%</span> of all sessions
                </span>
            </div>
        </div>
    </div>

    <!-- Filters and Search -->
    <div class="bg-white p-4 rounded-lg shadow">
        <div class="flex flex-col md:flex-row items-center justify-between gap-4">
            <div class="w-full md:w-1/3">
                <div class="relative">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <i class="fas fa-search text-gray-400"></i>
                    </div>
                    <input type="text" id="searchInput" placeholder="Search by student, counselor or office..." 
                           class="pl-10 pr-4 py-2 w-full border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
            </div>
            <div class="flex flex-wrap w-full md:w-2/3 gap-2 justify-end">
                <select id="officeFilter" class="border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="">All Offices</option>
                    {% for office in offices %}
                    <option value="{{ office.id }}">{{ office.name }}</option>
                    {% endfor %}
                </select>
                <select id="statusFilter" class="border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="">All Statuses</option>
                    <option value="pending">Pending</option>
                    <option value="completed">Completed</option>
                    <option value="cancelled">Cancelled</option>
                    <option value="no-show">No Show</option>
                </select>
                <input type="date" id="dateFilter" class="border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                <button id="resetFilters" class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-3 py-2 rounded-md flex items-center">
                    <i class="fas fa-redo-alt mr-1"></i> Reset
                </button>
            </div>
        </div>
    </div>

    <!-- Counseling Sessions Table -->
    <div class="bg-white rounded-lg shadow overflow-hidden">
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Student</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Office</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Counselor</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Scheduled Date</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200" id="counselingSessions">
                    {% for session in counseling_sessions %}
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{{ session.id }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ session.student.user.get_full_name() }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ session.office.name }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ session.counselor.get_full_name() }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ session.scheduled_at.strftime('%Y-%m-%d %H:%M') }}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full 
                                  {% if session.status == 'pending' %}bg-yellow-100 text-yellow-800
                                  {% elif session.status == 'completed' %}bg-green-100 text-green-800
                                  {% elif session.status == 'cancelled' %}bg-red-100 text-red-800
                                  {% elif session.status == 'no-show' %}bg-gray-100 text-gray-800
                                  {% else %}bg-blue-100 text-blue-800{% endif %}">
                                {{ session.status|capitalize }}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button data-id="{{ session.id }}" class="viewDetails text-blue-600 hover:text-blue-900 mr-3">
                                <i class="fas fa-eye"></i> View
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <!-- Pagination -->
        <div class="bg-white px-4 py-3 flex items-center justify-between border-t border-gray-200 sm:px-6">
            <div class="flex-1 flex justify-between sm:hidden">
                <button id="prevPage" class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                    Previous
                </button>
                <button id="nextPage" class="ml-3 relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                    Next
                </button>
            </div>
            <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
                <div>
                    <p class="text-sm text-gray-700">
                        Showing
                        <span class="font-medium" id="startItem">1</span>
                        to
                        <span class="font-medium" id="endItem">10</span>
                        of
                        <span class="font-medium" id="totalItems">{{ total_sessions }}</span>
                        results
                    </p>
                </div>
                <div>
                    <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px" aria-label="Pagination" id="paginationContainer">
                        <button id="prevPageBtn" class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                            <span class="sr-only">Previous</span>
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <div id="pageNumbers" class="flex">
                            <!-- Pagination numbers will be dynamically generated -->
                        </div>
                        <button id="nextPageBtn" class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                            <span class="sr-only">Next</span>
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </nav>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Session Detail Modal -->
<div id="sessionDetailModal" class="fixed inset-0 z-50 hidden overflow-y-auto">
    <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 transition-opacity" aria-hidden="true">
            <div class="absolute inset-0 bg-gray-500 opacity-75"></div>
        </div>
        <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
        <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
            <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                <div class="sm:flex sm:items-start">
                    <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-blue-100 sm:mx-0 sm:h-10 sm:w-10">
                        <i class="fas fa-calendar-alt text-blue-600"></i>
                    </div>
                    <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left w-full">
                        <h3 class="text-lg leading-6 font-medium text-gray-900" id="modalTitle">
                            Counseling Session Details
                        </h3>
                        <div class="mt-4 space-y-4">
                            <div class="border-b pb-2">
                                <div class="flex justify-between items-center">
                                    <span class="text-sm font-medium text-gray-500">Session ID:</span>
                                    <span class="text-sm text-gray-900" id="modalSessionId">-</span>
                                </div>
                            </div>
                            <div class="border-b pb-2">
                                <div class="flex justify-between items-center">
                                    <span class="text-sm font-medium text-gray-500">Student:</span>
                                    <span class="text-sm text-gray-900" id="modalStudent">-</span>
                                </div>
                            </div>
                            <div class="border-b pb-2">
                                <div class="flex justify-between items-center">
                                    <span class="text-sm font-medium text-gray-500">Office:</span>
                                    <span class="text-sm text-gray-900" id="modalOffice">-</span>
                                </div>
                            </div>
                            <div class="border-b pb-2">
                                <div class="flex justify-between items-center">
                                    <span class="text-sm font-medium text-gray-500">Counselor:</span>
                                    <span class="text-sm text-gray-900" id="modalCounselor">-</span>
                                </div>
                            </div>
                            <div class="border-b pb-2">
                                <div class="flex justify-between items-center">
                                    <span class="text-sm font-medium text-gray-500">Scheduled Date:</span>
                                    <span class="text-sm text-gray-900" id="modalScheduledDate">-</span>
                                </div>
                            </div>
                            <div class="border-b pb-2">
                                <div class="flex justify-between items-center">
                                    <span class="text-sm font-medium text-gray-500">Status:</span>
                                    <span class="text-sm text-gray-900" id="modalStatus">-</span>
                                </div>
                            </div>
                            <div>
                                <span class="text-sm font-medium text-gray-500">Notes:</span>
                                <p class="text-sm text-gray-900 mt-1" id="modalNotes">-</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                <button type="button" id="closeModal" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                    Close
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Global variables
    let currentPage = 1;
    const itemsPerPage = 10;
    let totalSessions = {{ total_sessions }};
    let totalPages = Math.ceil(totalSessions / itemsPerPage);
    
    // Modal functionality
    const modal = document.getElementById('sessionDetailModal');
    const closeModalBtn = document.getElementById('closeModal');
    initViewDetailsButtons();
    
    function initViewDetailsButtons() {
        const viewButtons = document.querySelectorAll('.viewDetails');
        viewButtons.forEach(button => {
            button.addEventListener('click', function() {
                const sessionId = this.getAttribute('data-id');
                fetchSessionDetails(sessionId);
            });
        });
    }
    
    closeModalBtn.addEventListener('click', hideModal);
    
    // Close modal when clicking outside
    window.addEventListener('click', function(event) {
        if (event.target === modal) {
            hideModal();
        }
    });
    
    function showModal() {
        modal.classList.remove('hidden');
    }
    
    function hideModal() {
        modal.classList.add('hidden');
    }
    
    // Search and filter functionality 
    const searchInput = document.getElementById('searchInput');
    const officeFilter = document.getElementById('officeFilter');
    const statusFilter = document.getElementById('statusFilter');
    const dateFilter = document.getElementById('dateFilter');
    const resetFiltersBtn = document.getElementById('resetFilters');
    
    // Debounce function to prevent too many API calls
    const debounce = (func, delay) => {
        let debounceTimer;
        return function() {
            const context = this;
            const args = arguments;
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => func.apply(context, args), delay);
        };
    };
    
    // Combined filter function - debounced for search
    const filterSessions = debounce(function(resetPage = true) {
        if (resetPage) {
            currentPage = 1;
        }
        
        const filters = getFilterParams();
        filters.append('page', currentPage);
        
        // Fetch filtered data from server
        fetch(`/admin/counseling-sessions/filter?${filters.toString()}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                updateSessionsTable(data);
                updatePagination(data.length);
            })
            .catch(error => {
                console.error('Error filtering sessions:', error);
                showErrorMessage('Failed to load sessions. Please try again.');
            });
    }, 300);
    
    function getFilterParams() {
        const searchValue = searchInput.value.trim();
        const officeValue = officeFilter.value;
        const statusValue = statusFilter.value;
        const dateValue = dateFilter.value;
        
        // Construct query parameters
        const params = new URLSearchParams();
        if (searchValue) params.append('search', searchValue);
        if (officeValue) params.append('office_id', officeValue);
        if (statusValue) params.append('status', statusValue);
        if (dateValue) params.append('date', dateValue);
        
        return params;
    }
    
    // Event listeners for filters
    searchInput.addEventListener('input', () => filterSessions(true));
    officeFilter.addEventListener('change', () => filterSessions(true));
    statusFilter.addEventListener('change', () => filterSessions(true));
    dateFilter.addEventListener('change', () => filterSessions(true));
    
    // Reset filters
    resetFiltersBtn.addEventListener('click', function() {
        searchInput.value = '';
        officeFilter.value = '';
        statusFilter.value = '';
        dateFilter.value = '';
        filterSessions(true);
    });
    
    // Export CSV functionality
    const exportCSVBtn = document.getElementById('exportCSV');
    exportCSVBtn.addEventListener('click', function() {
        const filters = getFilterParams();
        window.location.href = `/admin/counseling-sessions/export?${filters.toString()}`;
    });
    
    // Print report functionality
    const printReportBtn = document.getElementById('printReport');
    printReportBtn.addEventListener('click', function() {
        prepareAndPrintReport();
    });
    
    // Pagination functionality
    const prevPageBtn = document.getElementById('prevPageBtn');
    const nextPageBtn = document.getElementById('nextPageBtn');
    const prevPageMobile = document.getElementById('prevPage');
    const nextPageMobile = document.getElementById('nextPage');
    
    prevPageBtn.addEventListener('click', goToPrevPage);
    nextPageBtn.addEventListener('click', goToNextPage);
    prevPageMobile.addEventListener('click', goToPrevPage);
    nextPageMobile.addEventListener('click', goToNextPage);
    
    function goToPrevPage() {
        if (currentPage > 1) {
            currentPage--;
            filterSessions(false);
            updatePaginationControls();
        }
    }
    
    function goToNextPage() {
        if (currentPage < totalPages) {
            currentPage++;
            filterSessions(false);
            updatePaginationControls();
        }
    }
    
    function updatePaginationControls() {
        // Update pagination buttons state
        prevPageBtn.disabled = currentPage === 1;
        nextPageBtn.disabled = currentPage === totalPages;
        prevPageMobile.disabled = currentPage === 1;
        nextPageMobile.disabled = currentPage === totalPages;
        
        // Highlight current page
        updatePageNumbers();
    }
    
    function updatePageNumbers() {
        const pageNumbers = document.getElementById('pageNumbers');
        pageNumbers.innerHTML = '';
        
        // Determine page range to show
        let startPage = Math.max(1, currentPage - 2);
        let endPage = Math.min(totalPages, startPage + 4);
        
        // Adjust if we're near the end
        if (endPage - startPage < 4 && startPage > 1) {
            startPage = Math.max(1, endPage - 4);
        }
        
        // First page
        if (startPage > 1) {
            addPageNumberButton(1, pageNumbers);
            
            // Ellipsis if needed
            if (startPage > 2) {
                addEllipsis(pageNumbers);
            }
        }
        
        // Page numbers
        for (let i = startPage; i <= endPage; i++) {
            addPageNumberButton(i, pageNumbers);
        }
        
        // Last page
        if (endPage < totalPages) {
            // Ellipsis if needed
            if (endPage < totalPages - 1) {
                addEllipsis(pageNumbers);
            }
            
            addPageNumberButton(totalPages, pageNumbers);
        }
    }
    
    function addPageNumberButton(pageNum, container) {
        const button = document.createElement('button');
        button.textContent = pageNum;
        button.classList.add('relative', 'inline-flex', 'items-center', 'px-4', 'py-2', 'border', 'text-sm', 'font-medium');
        
        if (pageNum === currentPage) {
            button.classList.add('z-10', 'bg-blue-50', 'border-blue-500', 'text-blue-600');
        } else {
            button.classList.add('bg-white', 'border-gray-300', 'text-gray-500', 'hover:bg-gray-50');
            button.addEventListener('click', function() {
                currentPage = pageNum;
                filterSessions(false);
                updatePaginationControls();
            });
        }
        
        container.appendChild(button);
    }
    
    function addEllipsis(container) {
        const ellipsis = document.createElement('span');
        ellipsis.textContent = '...';
        ellipsis.classList.add('relative', 'inline-flex', 'items-center', 'px-4', 'py-2', 'border', 'border-gray-300', 'bg-white', 'text-sm', 'font-medium', 'text-gray-700');
        container.appendChild(ellipsis);
    }
    
    // Function to fetch session details
    function fetchSessionDetails(sessionId) {
        fetch(`/admin/counseling-sessions/${sessionId}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to fetch session details');
                }
                return response.json();
            })
            .then(data => {
                document.getElementById('modalSessionId').textContent = data.id;
                document.getElementById('modalStudent').textContent = data.student;
                document.getElementById('modalOffice').textContent = data.office;
                document.getElementById('modalCounselor').textContent = data.counselor;
                document.getElementById('modalScheduledDate').textContent = data.scheduled_at;
                
                // Format status with color
                const statusElement = document.getElementById('modalStatus');
                statusElement.textContent = data.status.charAt(0).toUpperCase() + data.status.slice(1);
                
                // Apply appropriate status color
                statusElement.className = 'text-sm font-semibold';
                if (data.status === 'pending') {
                    statusElement.classList.add('text-yellow-600');
                } else if (data.status === 'completed') {
                    statusElement.classList.add('text-green-600');
                } else if (data.status === 'cancelled') {
                    statusElement.classList.add('text-red-600');
                } else if (data.status === 'no-show') {
                    statusElement.classList.add('text-gray-600');
                }
                
                document.getElementById('modalNotes').textContent = data.notes;
                showModal();
            })
            .catch(error => {
                console.error('Error fetching session details:', error);
                showErrorMessage('Failed to load session details. Please try again.');
            });
    }
    
    // Function to show error message
    function showErrorMessage(message) {
        // Could be replaced with a toast notification in the future
        alert(message);
    }
    
     // Function to update sessions table and pagination info
     function updateSessionsTable(sessions) {
        const tableBody = document.getElementById('counselingSessions');
        tableBody.innerHTML = '';
        
        if (sessions.length === 0) {
            // Show no results message
            const noResultsRow = document.createElement('tr');
            noResultsRow.innerHTML = `
                <td colspan="7" class="px-6 py-4 text-center text-gray-500">
                    No counseling sessions found matching your filters.
                </td>
            `;
            tableBody.appendChild(noResultsRow);
            
            // Update pagination display
            document.getElementById('startItem').textContent = '0';
            document.getElementById('endItem').textContent = '0';
            document.getElementById('totalItems').textContent = '0';
            
            return;
        }
        
        sessions.forEach(session => {
            const row = document.createElement('tr');
            
            // Determine status class
            let statusClass = '';
            if (session.status === 'pending') {
                statusClass = 'bg-yellow-100 text-yellow-800';
            } else if (session.status === 'completed') {
                statusClass = 'bg-green-100 text-green-800';
            } else if (session.status === 'cancelled') {
                statusClass = 'bg-red-100 text-red-800';
            } else if (session.status === 'no-show') {
                statusClass = 'bg-gray-100 text-gray-800';
            } else {
                statusClass = 'bg-blue-100 text-blue-800';
            }
            
            // Format status for display
            const formattedStatus = session.status.charAt(0).toUpperCase() + session.status.slice(1);
            
            row.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${session.id}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${session.student}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${session.office}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${session.counselor}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${session.scheduled_at}</td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}">
                        ${formattedStatus}
                    </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                    <button data-id="${session.id}" class="viewDetails text-blue-600 hover:text-blue-900 mr-3">
                        <i class="fas fa-eye"></i> View
                    </button>
                </td>
            `;
            
            tableBody.appendChild(row);
        });
        
        // Re-initialize view detail buttons
        initViewDetailsButtons();
    }
    
    // Function to update pagination information
    function updatePagination(sessionCount) {
        // Calculate totals
        totalSessions = sessionCount;
        totalPages = Math.ceil(totalSessions / itemsPerPage) || 1; // Ensure at least 1 page
        
        // Update pagination display
        const startItem = ((currentPage - 1) * itemsPerPage) + 1;
        const endItem = Math.min(startItem + itemsPerPage - 1, totalSessions);
        
        document.getElementById('startItem').textContent = totalSessions > 0 ? startItem : 0;
        document.getElementById('endItem').textContent = endItem;
        document.getElementById('totalItems').textContent = totalSessions;
        
        // Update pagination controls
        updatePaginationControls();
    }
    
    // Function to prepare and print a report
    function prepareAndPrintReport() {
        const filters = getFilterParams();
        
        // Fetch all data for the report (without pagination)
        fetch(`/admin/counseling-sessions/filter?${filters.toString()}&printAll=true`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to generate report data');
                }
                return response.json();
            })
            .then(sessions => {
                if (sessions.length === 0) {
                    showErrorMessage('No data available to print.');
                    return;
                }
                
                // Generate report HTML
                const reportWindow = window.open('', '_blank');
                
                if (!reportWindow) {
                    showErrorMessage('Please allow popup windows to print reports.');
                    return;
                }
                
                // Get current filters for the report title
                const office = officeFilter.options[officeFilter.selectedIndex].text;
                const status = statusFilter.options[statusFilter.selectedIndex].text;
                const date = dateFilter.value ? new Date(dateFilter.value).toLocaleDateString() : 'All dates';
                const searchText = searchInput.value.trim() || 'All';
                
                // Create the report HTML content
                reportWindow.document.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>Counseling Sessions Report</title>
                        <style>
                            body { font-family: Arial, sans-serif; margin: 20px; }
                            h1 { color: #1a56db; text-align: center; margin-bottom: 20px; }
                            .report-info { margin-bottom: 20px; }
                            .report-info p { margin: 5px 0; }
                            table { width: 100%; border-collapse: collapse; }
                            th, td { border: 1px solid #e5e7eb; padding: 8px; text-align: left; }
                            th { background-color: #f3f4f6; }
                            .status-pending { color: #d97706; }
                            .status-completed { color: #059669; }
                            .status-cancelled { color: #dc2626; }
                            .status-no-show { color: #6b7280; }
                            .report-footer { margin-top: 30px; text-align: center; font-size: 12px; color: #6b7280; }
                            @media print {
                                .no-print { display: none; }
                            }
                        </style>
                    </head>
                    <body>
                        <h1>Counseling Sessions Report</h1>
                        
                        <div class="report-info">
                            <p><strong>Generated on:</strong> ${new Date().toLocaleString()}</p>
                            <p><strong>Office:</strong> ${office}</p>
                            <p><strong>Status:</strong> ${status}</p>
                            <p><strong>Date:</strong> ${date}</p>
                            <p><strong>Search:</strong> ${searchText}</p>
                            <p><strong>Total Sessions:</strong> ${sessions.length}</p>
                        </div>
                        
                        <table>
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Student</th>
                                    <th>Office</th>
                                    <th>Counselor</th>
                                    <th>Scheduled Date</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                `);
                
                // Add rows for each session
                sessions.forEach(session => {
                    let statusClass = '';
                    if (session.status === 'pending') statusClass = 'status-pending';
                    else if (session.status === 'completed') statusClass = 'status-completed';
                    else if (session.status === 'cancelled') statusClass = 'status-cancelled';
                    else if (session.status === 'no-show') statusClass = 'status-no-show';
                    
                    const formattedStatus = session.status.charAt(0).toUpperCase() + session.status.slice(1);
                    
                    reportWindow.document.write(`
                        <tr>
                            <td>${session.id}</td>
                            <td>${session.student}</td>
                            <td>${session.office}</td>
                            <td>${session.counselor}</td>
                            <td>${session.scheduled_at}</td>
                            <td class="${statusClass}">${formattedStatus}</td>
                        </tr>
                    `);
                });
                
                // Close the HTML
                reportWindow.document.write(`
                            </tbody>
                        </table>
                        
                        <div class="report-footer">
                            <p>KapiyuGuide Counseling Management System</p>
                        </div>
                        
                        <div class="no-print" style="text-align: center; margin-top: 20px;">
                            <button onclick="window.print()" style="padding: 10px 20px; background-color: #2563eb; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                Print Report
                            </button>
                        </div>
                    </body>
                    </html>
                `);
                
                reportWindow.document.close();
            })
            .catch(error => {
                console.error('Error generating report:', error);
                showErrorMessage('Failed to generate report. Please try again.');
            });
    }
    
    // Initialize the page
    function initPage() {
        // Set default date filter to empty
        dateFilter.value = '';
        
        // Initialize pagination
        updatePageNumbers();
        
        // Initial pagination button state
        prevPageBtn.disabled = currentPage === 1;
        nextPageBtn.disabled = currentPage === totalPages;
        prevPageMobile.disabled = currentPage === 1;
        nextPageMobile.disabled = currentPage === totalPages;
        
        // Check if the tables needs to be initialized with any filters from URL
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.has('office_id') || urlParams.has('status') || urlParams.has('date') || urlParams.has('search')) {
            // Set filter values from URL
            if (urlParams.has('office_id')) officeFilter.value = urlParams.get('office_id');
            if (urlParams.has('status')) statusFilter.value = urlParams.get('status');
            if (urlParams.has('date')) dateFilter.value = urlParams.get('date');
            if (urlParams.has('search')) searchInput.value = urlParams.get('search');
            
            // Apply filters
            filterSessions(true);
        }
    }
    
    // Handle errors in fetch requests
    window.addEventListener('error', function(e) {
        console.error('Global error caught:', e.error);
        showErrorMessage('An unexpected error occurred. Please refresh the page and try again.');
    });
    
    // Handle connectivity issues
    window.addEventListener('online', function() {
        const offlineMessage = document.getElementById('offlineMessage');
        if (offlineMessage) {
            offlineMessage.remove();
        }
    });
    
    window.addEventListener('offline', function() {
        // Check if offline message already exists
        if (!document.getElementById('offlineMessage')) {
            const offlineDiv = document.createElement('div');
            offlineDiv.id = 'offlineMessage';
            offlineDiv.className = 'fixed bottom-4 right-4 bg-red-600 text-white p-4 rounded-lg shadow-lg z-50';
            offlineDiv.innerHTML = `
                <div class="flex items-center">
                    <i class="fas fa-wifi-slash mr-2"></i>
                    <span>You are offline. Please check your internet connection.</span>
                </div>
            `;
            document.body.appendChild(offlineDiv);
        }
    });
    
    // Initialize page
    initPage();
});
</script>
{% endblock %}