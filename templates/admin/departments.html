{% extends "admin/adminbase.html" %}
{% block title %}Departments - {{ current_campus_name }} Admin{% endblock %}
{% block content %}
<div class="space-y-6">
  <div class="relative bg-gradient-to-br from-blue-900 via-indigo-900 to-sky-900 rounded-3xl shadow-2xl p-8 text-white overflow-hidden">
    <div class="relative z-10 flex flex-col lg:flex-row justify-between items-start lg:items-center gap-6">
      <div class="flex-1">
        <div class="flex items-center mb-4">
          <div class="w-16 h-16 bg-white/20 backdrop-blur-sm rounded-2xl flex items-center justify-center mr-4">
            <i class="fas fa-layer-group text-2xl text-white"></i>
          </div>
          <div>
            <h1 class="text-3xl font-bold mb-1">Departments</h1>
            <p class="text-blue-200">Manage departments for {{ campus.name if campus else current_campus_name }}</p>
          </div>
        </div>
      </div>
      <div class="flex items-center gap-3">
        <button type="button" id="btnAdd" class="group flex items-center bg-gradient-to-r from-blue-600 to-sky-600 hover:from-blue-700 hover:to-sky-700 text-white font-semibold py-3 px-6 rounded-2xl transition-all shadow-lg">
          <i class="fas fa-plus-circle mr-2"></i>
          Add Department
        </button>
      </div>
    </div>
  </div>

  <div class="bg-white/70 backdrop-blur-lg rounded-3xl shadow-2xl border border-white/20 overflow-hidden transition-all duration-300">
    <div class="bg-gradient-to-r from-gray-50 to-blue-50 px-6 py-5 border-b border-gray-200 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 bg-gradient-to-r from-blue-600 to-sky-600 rounded-2xl flex items-center justify-center text-white">
          <i class="fas fa-list"></i>
        </div>
        <div>
          <h2 class="text-xl font-bold text-gray-900">Department List</h2>
          <p class="text-gray-600 text-sm">Create, edit, and remove departments. Students can pick these in their profiles.</p>
        </div>
      </div>
      <div class="hidden md:flex items-center gap-2 text-sm text-gray-600">
        <i class="fas fa-search"></i>
        <input id="search" type="text" placeholder="Search departments" class="px-3 py-2 rounded-lg border border-gray-200 focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500" />
      </div>
    </div>

    <div class="p-6 md:p-8">
      {% if departments %}
      <div class="overflow-x-auto">
        <table class="min-w-full" id="deptTable">
          <thead class="bg-gradient-to-r from-blue-50 to-indigo-50">
            <tr>
              <th class="px-6 py-4 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Name</th>
              <th class="px-6 py-4 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Code</th>
              <th class="px-6 py-4 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Description</th>
              <th class="px-6 py-4 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Status</th>
              <th class="px-6 py-4 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Actions</th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-100">
            {% for d in departments %}
            <tr class="hover:bg-gradient-to-r hover:from-blue-50 hover:to-indigo-50 transition-all duration-300" data-id="{{ d.id }}">
              <td class="px-6 py-4"><div class="text-sm font-bold text-gray-900">{{ d.name }}</div></td>
              <td class="px-6 py-4"><div class="text-gray-700 text-sm">{{ d.code or '—' }}</div></td>
              <td class="px-6 py-4"><div class="text-gray-600 text-sm">{{ d.description or '' }}</div></td>
              <td class="px-6 py-4 whitespace-nowrap">
                {% if d.is_active %}
                <span class="px-2 py-1 text-xs rounded-full bg-emerald-50 text-emerald-700 border border-emerald-200">Active</span>
                {% else %}
                <span class="px-2 py-1 text-xs rounded-full bg-gray-50 text-gray-700 border border-gray-200">Inactive</span>
                {% endif %}
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                <div class="flex space-x-3">
                  <button class="js-edit group bg-purple-100 hover:bg-purple-200 text-purple-700 p-3 rounded-xl transition-all duration-300 transform hover:scale-110" title="Edit Department">
                    <i class="fas fa-edit group-hover:scale-110 transition-transform"></i>
                  </button>
                  <button class="js-delete group bg-red-100 hover:bg-red-200 text-red-700 p-3 rounded-xl transition-all duration-300 transform hover:scale-110" title="Delete Department">
                    <i class="fas fa-trash group-hover:scale-110 transition-transform"></i>
                  </button>
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <div class="py-12 text-center">
        <div class="w-16 h-16 bg-gradient-to-r from-blue-100 to-sky-100 rounded-full mx-auto mb-4 flex items-center justify-center">
          <i class="fas fa-layer-group text-blue-400 text-2xl"></i>
        </div>
        <h3 class="text-lg font-semibold text-gray-900 mb-1">No departments yet</h3>
        <p class="text-gray-600 mb-4">Create the first department to get started.</p>
        <button type="button" id="btnAdd2" class="inline-flex items-center px-6 py-3 bg-gradient-to-r from-blue-600 to-sky-600 text-white rounded-xl hover:from-blue-700 hover:to-sky-700 transition-all shadow">
          <i class="fas fa-plus-circle mr-2"></i> Add Department
        </button>
      </div>
      {% endif %}
    </div>
  </div>
</div>

<!-- Modal (Centered, consistent with Admin/Student pages) -->
<div id="deptModal" class="fixed inset-0 z-50 overflow-y-auto hidden backdrop-blur-sm" aria-modal="true" role="dialog">
  <div class="flex items-center justify-center min-h-screen p-4 text-center sm:block sm:p-0">
    <div class="fixed inset-0 transition-opacity" aria-hidden="true">
      <div class="absolute inset-0 bg-gray-900 opacity-75"></div>
    </div>
    <div class="inline-block align-bottom bg-white rounded-xl text-left overflow-hidden shadow-2xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full border-0">
      <div class="flex justify-between items-center px-6 py-4 bg-gradient-to-r from-indigo-600 to-indigo-700 text-white">
        <h3 id="modalTitle" class="text-lg font-bold flex items-center">
          <i class="fas fa-layer-group mr-2"></i>
          Add Department
        </h3>
        <button type="button" class="close-modal text-white hover:text-gray-200 transition-colors duration-300 p-2 rounded-full hover:bg-white/10">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="bg-white px-6 py-6">
        <form id="deptForm" class="space-y-4">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-1">Name *</label>
            <input name="name" id="fName" type="text" required maxlength="120" class="w-full px-3 py-2 rounded-lg border-2 border-gray-200 focus:ring-4 focus:ring-blue-500/20 focus:border-blue-500" />
          </div>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-1">Code</label>
              <input name="code" id="fCode" type="text" maxlength="20" class="w-full px-3 py-2 rounded-lg border-2 border-gray-200 focus:ring-4 focus:ring-blue-500/20 focus:border-blue-500" />
            </div>
            <div class="flex items-end">
              <label class="inline-flex items-center cursor-pointer select-none">
                <input id="fActive" type="checkbox" class="sr-only peer" checked />
                <div class="w-11 h-6 bg-gray-200 rounded-full peer peer-checked:bg-emerald-600 transition-colors relative">
                  <div class="absolute top-0.5 left-0.5 w-5 h-5 bg-white rounded-full transition-all peer-checked:left-5 shadow"></div>
                </div>
                <span class="ml-3 text-sm text-gray-800">Active</span>
              </label>
            </div>
          </div>
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-1">Description</label>
            <textarea name="description" id="fDesc" rows="3" maxlength="500" class="w-full px-3 py-2 rounded-lg border-2 border-gray-200 focus:ring-4 focus:ring-blue-500/20 focus:border-blue-500"></textarea>
          </div>
        </form>
      </div>
      <div class="bg-gray-50 px-6 py-4 sm:flex sm:flex-row-reverse border-t border-gray-200">
        <button type="submit" form="deptForm" id="btnSave" class="w-full inline-flex justify-center rounded-lg border border-transparent shadow-sm px-4 py-2 bg-indigo-600 text-base font-medium text-white hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:ml-3 sm:w-auto sm:text-sm transition-all duration-300 transform hover:scale-105">
          <i class="fas fa-save mr-2"></i>
          Save
        </button>
        <button type="button" class="close-modal mt-3 w-full inline-flex justify-center rounded-lg border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:w-auto sm:text-sm transition-all duration-300">
          <i class="fas fa-times mr-2"></i>
          Cancel
        </button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  (function(){
    const modal = document.getElementById('deptModal');
    const btnAdd = document.getElementById('btnAdd');
    const btnAdd2 = document.getElementById('btnAdd2');
  // Close buttons are unified via .close-modal
    const form = document.getElementById('deptForm');
    const fName = document.getElementById('fName');
    const fCode = document.getElementById('fCode');
    const fDesc = document.getElementById('fDesc');
    const fActive = document.getElementById('fActive');
    const modalTitle = document.getElementById('modalTitle');
    const search = document.getElementById('search');
    let editId = null;

    function openModal(mode, row){
      modal.classList.remove('hidden');
      if(mode==='add'){
        modalTitle.textContent = 'Add Department';
        form.reset();
        fActive.checked = true;
        editId = null;
      } else {
        modalTitle.textContent = 'Edit Department';
        editId = parseInt(row.dataset.id,10);
        fName.value = row.children[0].innerText.trim();
        fCode.value = row.children[1].innerText.trim() === '—' ? '' : row.children[1].innerText.trim();
        fDesc.value = row.children[2].innerText.trim();
        fActive.checked = row.querySelector('span.bg-emerald-50') !== null;
      }
      setTimeout(()=>fName.focus(), 50);
    }
    function closeModal(){ modal.classList.add('hidden'); }

    btnAdd && btnAdd.addEventListener('click', ()=>openModal('add'));
    btnAdd2 && btnAdd2.addEventListener('click', ()=>openModal('add'));
    document.querySelectorAll('#deptModal .close-modal').forEach(btn=>btn.addEventListener('click', closeModal));
    window.addEventListener('keydown', e=>{ if(e.key==='Escape') closeModal(); });
  // Click on overlay to close
  const overlay = document.querySelector('#deptModal .absolute.inset-0');
  overlay && overlay.addEventListener('click', closeModal);

    // Delegated actions on table
    document.addEventListener('click', function(e){
      const editBtn = e.target.closest('.js-edit');
      if(editBtn){
        const row = editBtn.closest('tr');
        openModal('edit', row);
        return;
      }
      const delBtn = e.target.closest('.js-delete');
      if(delBtn){
        const row = delBtn.closest('tr');
        const id = parseInt(row.dataset.id,10);
        if(confirm('Delete this department?')){
          fetch(`/admin/departments/${id}`, {method:'DELETE', headers: {'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content}})
            .then(r=>r.json().then(j=>({ok:r.ok, j})))
            .then(({ok,j})=>{
              if(!ok){ alert(j.error || 'Failed'); return; }
              row.remove();
            }).catch(()=>alert('Network error'));
        }
      }
    });

    // Save form via fetch
    form.addEventListener('submit', function(e){
      e.preventDefault();
      const payload = {
        name: fName.value.trim(),
        code: fCode.value.trim(),
        description: fDesc.value.trim(),
        is_active: !!fActive.checked
      };
      const headers = {'Content-Type':'application/json','X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content};
      const url = editId? `/admin/departments/${editId}` : '/admin/departments';
      const method = editId? 'PATCH' : 'POST';
      fetch(url, {method, headers, body: JSON.stringify(payload)})
        .then(r=>r.json().then(j=>({ok:r.ok, j})))
        .then(({ok, j})=>{
          if(!ok){ alert(j.error || 'Failed'); return; }
          // Update UI optimistically
          if(!editId){
            const tbody = document.querySelector('#deptTable tbody');
            if(tbody){
              const tr = document.createElement('tr');
              tr.className = 'hover:bg-gradient-to-r hover:from-blue-50 hover:to-indigo-50 transition-all duration-300';
              tr.dataset.id = j.department.id;
              tr.innerHTML = `
                <td class="px-6 py-4"><div class="text-sm font-bold text-gray-900">${payload.name}</div></td>
                <td class="px-6 py-4"><div class="text-gray-700 text-sm">${payload.code || '—'}</div></td>
                <td class="px-6 py-4"><div class="text-gray-600 text-sm">${payload.description || ''}</div></td>
                <td class="px-6 py-4">${payload.is_active ? '<span class="px-2 py-1 text-xs rounded-full bg-emerald-50 text-emerald-700 border border-emerald-200">Active</span>' : '<span class="px-2 py-1 text-xs rounded-full bg-gray-50 text-gray-700 border border-gray-200">Inactive</span>'}</td>
                <td class="px-6 py-4">
                  <div class="flex space-x-3">
                    <button class="js-edit group bg-purple-100 hover:bg-purple-200 text-purple-700 p-3 rounded-xl transition-all duration-300 transform hover:scale-110" title="Edit Department">
                      <i class="fas fa-edit group-hover:scale-110 transition-transform"></i>
                    </button>
                    <button class="js-delete group bg-red-100 hover:bg-red-200 text-red-700 p-3 rounded-xl transition-all duration-300 transform hover:scale-110" title="Delete Department">
                      <i class="fas fa-trash group-hover:scale-110 transition-transform"></i>
                    </button>
                  </div>
                </td>`;
              tbody.prepend(tr);
            } else {
              // first add scenario without table
              window.location.reload();
            }
          } else {
            const row = document.querySelector(`tr[data-id="${editId}"]`);
            if(row){
              row.children[0].innerText = payload.name;
              row.children[1].innerText = payload.code || '—';
              row.children[2].innerText = payload.description || '';
              const statusCell = row.children[3];
              statusCell.innerHTML = payload.is_active ?
                '<span class="px-2 py-1 text-xs rounded-full bg-emerald-50 text-emerald-700 border border-emerald-200">Active</span>' :
                '<span class="px-2 py-1 text-xs rounded-full bg-gray-50 text-gray-700 border border-gray-200">Inactive</span>';
            }
          }
          closeModal();
        }).catch(()=>alert('Network error'));
    });

    // Search filter
    if(search){
      search.addEventListener('input', function(){
        const q = this.value.toLowerCase();
        document.querySelectorAll('#deptTable tbody tr').forEach(tr=>{
          const name = tr.children[0].innerText.toLowerCase();
          const code = tr.children[1].innerText.toLowerCase();
          const desc = tr.children[2].innerText.toLowerCase();
          tr.style.display = (name.includes(q) || code.includes(q) || desc.includes(q)) ? '' : 'none';
        });
      });
    }
  })();
</script>
{% endblock %}
